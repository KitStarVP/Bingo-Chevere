<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Bingo Chévere</title>
    <link rel="stylesheet" href="css/landing.css">
    <link rel="stylesheet" href="css/new-nav.css">
    <link rel="stylesheet" href="css/popup.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="main-container">
        <header class="landing-header">
            <div class="logo">
                <span class="logo-main">ADMIN</span>
                <span class="logo-tagline">Panel</span>
            </div>
        </header>

        <main class="admin-section">
            <div class="admin-card">
                <h2>Programación de Bingos</h2>
                <div class="schedule-info">
                    <div class="current-bingo">
                        <span>Bingo Actual: <strong id="current-bingo">Seleccionar horario</strong></span>
                    </div>
                    <div id="schedule-times" class="schedule-times">
                        <!-- Horarios se cargarán dinámicamente -->
                    </div>
                </div>
                <div class="schedule-management">
                    <div class="add-schedule">
                        <input type="time" id="new-time" placeholder="HH:MM">
                        <button id="add-schedule" class="admin-btn small">+ Agregar</button>
                    </div>
                </div>
                <div class="admin-controls">
                    <button id="start-round" class="admin-btn primary" disabled>Iniciar Ronda</button>
                    <button id="end-round" class="admin-btn secondary">Finalizar Ronda</button>
                    <button id="reset-prizes" class="admin-btn danger">Reset Premios</button>
                </div>
            </div>

            <div class="admin-card">
                <h2>Gestión de Pagos</h2>
                <div class="payment-stats">
                    <div class="payment-stat" onclick="showPayments('pending')">
                        <span class="stat-number" id="pending-count">0</span>
                        <span class="stat-label">Pendientes</span>
                    </div>
                    <div class="payment-stat" onclick="showPayments('verified')">
                        <span class="stat-number" id="verified-count">0</span>
                        <span class="stat-label">Verificados</span>
                    </div>
                    <div class="payment-stat" onclick="showPayments('rejected')">
                        <span class="stat-number" id="rejected-count">0</span>
                        <span class="stat-label">Rechazados</span>
                    </div>
                </div>
                
                <div id="payment-modal" class="payment-modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="modal-title">Pagos</h3>
                            <button class="close-modal" onclick="closePaymentModal()">×</button>
                        </div>
                        <div class="search-filters">
                            <input type="date" id="date-filter" placeholder="Fecha">
                            <input type="tel" id="phone-filter" placeholder="Teléfono">
                            <button onclick="filterPayments()">Buscar</button>
                        </div>
                        <div id="payments-list" class="payments-list">
                            <!-- Pagos se cargarán aquí -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="admin-card">
                <h2>Gestión de Usuarios</h2>
                <div class="user-search">
                    <select id="user-dropdown" onchange="selectUserFromDropdown()">
                        <option value="">Seleccionar jugador...</option>
                    </select>
                    <span style="margin: 0 0.5rem; color: #666;">o</span>
                    <input type="tel" id="user-phone-search" placeholder="Buscar por teléfono">
                    <button onclick="searchUser()" class="admin-btn small">Buscar</button>
                </div>
                <div id="user-profile" class="user-profile" style="display: none;">
                    <!-- Perfil del usuario se cargará aquí -->
                </div>
            </div>

            <div class="admin-card">
                <h2>Estadísticas</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Ronda Actual</span>
                        <span id="current-round" class="stat-value">1 de 2</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Cartones Vendidos</span>
                        <span id="tickets-sold" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Premio Ronda</span>
                        <span id="round-prize" class="stat-value">BsF 0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Premio Total Hoy</span>
                        <span id="daily-total" class="stat-value">BsF 0</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <nav class="new-bottom-nav">
        <a href="index.html" class="new-nav-item">
            <svg class="new-nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <span class="new-nav-label">Inicio</span>
        </a>
        <a href="comprar-cartones.html" class="new-nav-item">
            <svg class="new-nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"></path><path d="M13 5v2"></path><path d="M13 17v2"></path><path d="M13 11v2"></path></svg>
            <span class="new-nav-label">Cartones</span>
        </a>
        <a href="juego.html" class="new-nav-item">
            <svg class="new-nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            <span class="new-nav-label">Jugar</span>
        </a>
        <a href="premios.html" class="new-nav-item">
            <svg class="new-nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C17.15 18.75 18 20.24 18 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>
            <span class="new-nav-label">Premios</span>
        </a>
        <a href="perfil.html" class="new-nav-item">
            <svg class="new-nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <span class="new-nav-label">Perfil</span>
        </a>
    </nav>

    <style>
        .admin-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 500px;
            padding-bottom: 2rem;
        }

        .admin-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .admin-card h2 {
            margin: 0 0 1rem 0;
            color: var(--accent-color);
            font-size: 1.1rem;
            text-align: center;
        }

        .admin-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .admin-btn {
            padding: 0.7rem 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .admin-btn.primary {
            background: #28a745;
            color: white;
        }

        .admin-btn.secondary {
            background: #ffc107;
            color: #212529;
        }

        .admin-btn.danger {
            background: #dc3545;
            color: white;
        }

        .admin-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .payments-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .payment-actions {
            display: flex;
            gap: 0.3rem;
        }

        .payment-btn {
            padding: 0.3rem 0.6rem;
            border: none;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .approve-btn {
            background: #28a745;
            color: white;
        }

        .reject-btn {
            background: #dc3545;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }


        
        .schedule-info {
            text-align: center;
            margin-bottom: 1rem;
        }

        .current-bingo {
            background: #e8f0fe;
            padding: 0.5rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .schedule-times {
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
        }

        .time-slot {
            background: #f8f9fa;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .time-slot.active {
            background: var(--accent-color);
            color: white;
        }

        .time-slot.selected {
            background: #28a745;
            color: white;
        }

        .delete-time {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .schedule-management {
            margin: 0.5rem 0;
        }

        .add-schedule {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
        }

        #new-time {
            padding: 0.4rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .admin-btn.small {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        .payment-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .payment-stat {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .payment-stat:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .stat-number {
            display: block;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .stat-label {
            font-size: 0.7rem;
            color: #666;
        }

        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--accent-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .search-filters {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .search-filters input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .search-filters button {
            padding: 0.5rem 1rem;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .payments-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 1rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .user-cards-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
        }

        .stat-value {
            font-weight: bold;
            color: var(--accent-color);
        }

        .user-search {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .user-search select {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
        }

        .user-search input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .user-profile {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
        }

        .user-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .user-stat {
            background: white;
            padding: 0.5rem;
            border-radius: 4px;
            text-align: center;
        }

        .user-stat-number {
            display: block;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .user-stat-label {
            font-size: 0.7rem;
            color: #666;
        }

        .user-history {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            background: white;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .history-date {
            font-weight: bold;
            color: var(--accent-color);
        }
    </style>

    <script src="js/popup.js"></script>
    <script src="js/loader.js"></script>
    <script>
        // Sistema de bingos diarios
        let selectedBingoIndex = -1;
        let currentRound = 1;
        let gameActive = false;
        let dailySchedule = [
            { time: '13:00', label: '1:00 PM', completed: false },
            { time: '17:00', label: '5:00 PM', completed: false },
            { time: '21:00', label: '9:00 PM', completed: false }
        ];
        let ticketsSoldToday = 0;
        let dailyPrizeTotal = 0;
        let allPayments = [];
        let currentFilter = 'pending';
        let filteredPayments = [];
        let calledNumbers = [];
        let callingInterval = null;
        let currentPattern = null;
        
        // Patrones únicos y complicados
        const bingoPatterns = [
            {
                name: "Cruz Diagonal",
                description: "Ambas diagonales completas",
                positions: [[0,0],[1,1],[2,2],[3,3],[4,4],[0,4],[1,3],[2,2],[3,1],[4,0]]
            },
            {
                name: "Marcos Dobles",
                description: "Bordes exteriores e interiores",
                positions: [[0,0],[0,1],[0,2],[0,3],[0,4],[1,0],[1,4],[2,0],[2,4],[3,0],[3,4],[4,0],[4,1],[4,2],[4,3],[4,4],[1,1],[1,2],[1,3],[2,1],[2,3],[3,1],[3,2],[3,3]]
            },
            {
                name: "Estrella de 8 Puntas",
                description: "Patrón de estrella compleja",
                positions: [[0,2],[1,1],[1,3],[2,0],[2,2],[2,4],[3,1],[3,3],[4,2],[1,0],[1,4],[0,1],[0,3],[3,0],[3,4],[4,1],[4,3]]
            },
            {
                name: "Espiral Completa",
                description: "Espiral desde esquina",
                positions: [[0,0],[0,1],[0,2],[0,3],[0,4],[1,4],[2,4],[3,4],[4,4],[4,3],[4,2],[4,1],[4,0],[3,0],[2,0],[1,0],[1,1],[1,2],[1,3],[2,3],[3,3],[3,2],[3,1],[2,1],[2,2]]
            },
            {
                name: "Diamante Expandido",
                description: "Diamante con extensiones",
                positions: [[0,2],[1,1],[1,2],[1,3],[2,0],[2,1],[2,2],[2,3],[2,4],[3,1],[3,2],[3,3],[4,2],[0,1],[0,3],[1,0],[1,4],[3,0],[3,4],[4,1],[4,3]]
            },
            {
                name: "Zigzag Completo",
                description: "Patrón zigzag por todo el cartón",
                positions: [[0,0],[0,2],[0,4],[1,1],[1,3],[2,0],[2,2],[2,4],[3,1],[3,3],[4,0],[4,2],[4,4]]
            },
            {
                name: "Cuadrados Anidados",
                description: "Tres cuadrados concéntricos",
                positions: [[0,0],[0,1],[0,2],[0,3],[0,4],[1,0],[1,4],[2,0],[2,4],[3,0],[3,4],[4,0],[4,1],[4,2],[4,3],[4,4],[1,1],[1,2],[1,3],[2,1],[2,3],[3,1],[3,2],[3,3]]
            },
            {
                name: "Flecha Doble",
                description: "Dos flechas apuntando al centro",
                positions: [[0,0],[0,4],[1,1],[1,3],[2,2],[3,1],[3,3],[4,0],[4,4],[1,0],[1,4],[2,1],[2,3],[3,0],[3,4]]
            }
        ];

        // Inicializar panel
        document.addEventListener('DOMContentLoaded', () => {
            loadPendingPurchases();
            updatePaymentStats();
            updateStats();
            renderSchedule();
            
            // Event listener para agregar horario
            document.getElementById('add-schedule').addEventListener('click', addNewSchedule);
            
            // Actualizar pagos cada 5 segundos
            setInterval(loadPendingPurchases, 5000);
        });
        
        // Cargar compras pendientes
        function loadPendingPurchases() {
            const pendingPurchases = JSON.parse(localStorage.getItem('pendingPurchases') || '[]');
            const verifiedPurchases = JSON.parse(localStorage.getItem('verifiedPurchases') || '[]');
            const rejectedPurchases = JSON.parse(localStorage.getItem('rejectedPurchases') || '[]');
            
            allPayments = [...pendingPurchases, ...verifiedPurchases, ...rejectedPurchases];
            updatePaymentStats();
        }

        // Controles de rondas
        document.getElementById('start-round').addEventListener('click', () => {
            if (selectedBingoIndex === -1) {
                showPopup('Error', 'Selecciona un horario de bingo primero');
                return;
            }
            gameActive = true;
            const selectedBingo = dailySchedule[selectedBingoIndex];
            
            // Iniciar cantado automático
            startAutomaticCalling();
            
            showPopup('Ronda Iniciada', `Iniciando ronda ${currentRound} del bingo de las ${selectedBingo.label}`);
            updateStats();
        });

        document.getElementById('end-round').addEventListener('click', () => {
            gameActive = false;
            
            // Detener cantado automático
            stopAutomaticCalling();
            
            // Limpiar números cantados
            calledNumbers = [];
            
            if (currentRound === 2) {
                // Completar bingo actual
                if (selectedBingoIndex !== -1) {
                    dailySchedule[selectedBingoIndex].completed = true;
                }
                currentRound = 1;
                selectedBingoIndex = -1;
                showPopup('Bingo Completado', 'Las 2 rondas han terminado. Selecciona el próximo horario.');
            } else {
                currentRound = 2;
                showPopup('Ronda Finalizada', 'Ronda 1 completada. Preparando ronda 2...');
            }
            
            // Limpiar estado del juego completamente
            localStorage.removeItem('bingoGameState');
            
            renderSchedule();
            updateStats();
        });

        document.getElementById('reset-prizes').addEventListener('click', () => {
            dailyPrizeTotal = 0;
            ticketsSoldToday = 0;
            selectedBingoIndex = -1;
            currentRound = 1;
            gameActive = false;
            calledNumbers = [];
            dailySchedule.forEach(bingo => bingo.completed = false);
            
            // Detener cantado automático
            stopAutomaticCalling();
            
            // Limpiar estado del juego completamente
            localStorage.removeItem('bingoGameState');
            
            showPopup('Premios Reseteados', 'Todos los premios y estadísticas han sido reiniciados.');
            renderSchedule();
            updateStats();
        });

        // Actualizar estadísticas de pagos
        function updatePaymentStats() {
            const pending = allPayments.filter(p => p.status === 'pending').length;
            const verified = allPayments.filter(p => p.status === 'verified').length;
            const rejected = allPayments.filter(p => p.status === 'rejected').length;
            
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('verified-count').textContent = verified;
            document.getElementById('rejected-count').textContent = rejected;
        }

        // Mostrar pagos por categoría
        function showPayments(status) {
            currentFilter = status;
            const titles = {
                'pending': 'Pagos Pendientes',
                'verified': 'Pagos Verificados', 
                'rejected': 'Pagos Rechazados'
            };
            
            document.getElementById('modal-title').textContent = titles[status];
            document.getElementById('payment-modal').style.display = 'flex';
            
            filterPayments();
        }

        // Cerrar modal
        function closePaymentModal() {
            document.getElementById('payment-modal').style.display = 'none';
            document.getElementById('date-filter').value = '';
            document.getElementById('phone-filter').value = '';
        }

        // Filtrar pagos
        function filterPayments() {
            const dateFilter = document.getElementById('date-filter').value;
            const phoneFilter = document.getElementById('phone-filter').value;
            
            filteredPayments = allPayments.filter(payment => {
                const matchStatus = payment.status === currentFilter;
                const matchDate = !dateFilter || payment.date === dateFilter;
                const matchPhone = !phoneFilter || payment.phone.includes(phoneFilter);
                
                return matchStatus && matchDate && matchPhone;
            });
            
            renderPaymentsList();
        }

        // Renderizar lista de pagos
        function renderPaymentsList() {
            const container = document.getElementById('payments-list');
            container.innerHTML = '';
            
            if (filteredPayments.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666;">No se encontraron pagos</p>';
                return;
            }
            
            filteredPayments.forEach(payment => {
                const item = document.createElement('div');
                item.className = 'payment-item';
                
                let actions = '';
                if (payment.status === 'pending') {
                    actions = `
                        <div class="payment-actions">
                            <button class="payment-btn approve-btn" onclick="approvePayment(${payment.id})">✓</button>
                            <button class="payment-btn reject-btn" onclick="rejectPayment(${payment.id})">✗</button>
                        </div>
                    `;
                } else if (payment.status === 'verified') {
                    actions = `
                        <div class="payment-actions">
                            <button class="payment-btn reject-btn" onclick="rejectVerifiedPayment(${payment.id})">✗ Rechazar</button>
                        </div>
                    `;
                }
                
                item.innerHTML = `
                    <div>
                        <strong>Ref: ${payment.ref}</strong> - <strong>${payment.phone}</strong><br>
                        <small>${payment.cartones} cartones - BsF ${payment.amount} - ${payment.date}</small>
                    </div>
                    ${actions}
                `;
                container.appendChild(item);
            });
        }

        // Aprobar pago
        function approvePayment(paymentId) {
            let pendingPurchases = JSON.parse(localStorage.getItem('pendingPurchases') || '[]');
            let verifiedPurchases = JSON.parse(localStorage.getItem('verifiedPurchases') || '[]');
            
            const paymentIndex = pendingPurchases.findIndex(p => p.id === paymentId);
            if (paymentIndex !== -1) {
                const payment = pendingPurchases[paymentIndex];
                payment.status = 'verified';
                
                // Mover de pendientes a verificados
                pendingPurchases.splice(paymentIndex, 1);
                verifiedPurchases.push(payment);
                
                // Actualizar localStorage
                localStorage.setItem('pendingPurchases', JSON.stringify(pendingPurchases));
                localStorage.setItem('verifiedPurchases', JSON.stringify(verifiedPurchases));
                
                ticketsSoldToday += payment.cartones;
                dailyPrizeTotal += payment.amount * 0.75; // 75% va a premios
                
                showPopup('Pago Aprobado', `Se han asignado ${payment.cartones} cartones al teléfono ${payment.phone}`);
                loadPendingPurchases();
                filterPayments();
                updateStats();
            }
        }

        // Rechazar pago
        function rejectPayment(paymentId) {
            let pendingPurchases = JSON.parse(localStorage.getItem('pendingPurchases') || '[]');
            let rejectedPurchases = JSON.parse(localStorage.getItem('rejectedPurchases') || '[]');
            
            const paymentIndex = pendingPurchases.findIndex(p => p.id === paymentId);
            if (paymentIndex !== -1) {
                const payment = pendingPurchases[paymentIndex];
                payment.status = 'rejected';
                
                // Mover de pendientes a rechazados
                pendingPurchases.splice(paymentIndex, 1);
                rejectedPurchases.push(payment);
                
                // Actualizar localStorage
                localStorage.setItem('pendingPurchases', JSON.stringify(pendingPurchases));
                localStorage.setItem('rejectedPurchases', JSON.stringify(rejectedPurchases));
                
                showPopup('Pago Rechazado', `Pago del teléfono ${payment.phone} ha sido rechazado.`);
                loadPendingPurchases();
                filterPayments();
            }
        }

        // Rechazar pago verificado
        function rejectVerifiedPayment(paymentId) {
            const payment = allPayments.find(p => p.id === paymentId);
            if (payment) {
                payment.status = 'rejected';
                ticketsSoldToday -= payment.cartones;
                dailyPrizeTotal -= payment.amount * 0.75;
                
                showPopup('Pago Corregido', `Pago verificado del teléfono ${payment.phone} ha sido rechazado. Cartones retirados.`);
                updatePaymentStats();
                filterPayments();
                updateStats();
            }
        }

        // Actualizar estadísticas
        function updateStats() {
            document.getElementById('current-round').textContent = `${currentRound} de 2`;
            document.getElementById('tickets-sold').textContent = ticketsSoldToday;
            
            const roundPrize = ticketsSoldToday * 60 * 0.375; // 37.5% por ronda
            document.getElementById('round-prize').textContent = `BsF ${roundPrize.toFixed(2)}`;
            document.getElementById('daily-total').textContent = `BsF ${dailyPrizeTotal.toFixed(2)}`;
            
            // Actualizar estado del juego si está activo
            if (gameActive) {
                saveGameState();
            }
        }

        // Renderizar horarios dinámicamente
        function renderSchedule() {
            const container = document.getElementById('schedule-times');
            container.innerHTML = '';
            
            dailySchedule.forEach((bingo, index) => {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                if (index === selectedBingoIndex) slot.classList.add('selected');
                if (bingo.completed) slot.classList.add('active');
                
                slot.innerHTML = `
                    <span>${bingo.label}</span>
                    <button class="delete-time" onclick="deleteSchedule(${index})">×</button>
                `;
                
                slot.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-time')) return;
                    selectBingo(index);
                });
                
                container.appendChild(slot);
            });
            
            updateScheduleDisplay();
        }

        // Seleccionar bingo
        function selectBingo(index) {
            if (dailySchedule[index].completed) {
                showPopup('Bingo Completado', 'Este horario ya fue completado.');
                return;
            }
            selectedBingoIndex = index;
            document.getElementById('start-round').disabled = false;
            renderSchedule();
        }

        // Actualizar display de horarios
        function updateScheduleDisplay() {
            const display = document.getElementById('current-bingo');
            if (selectedBingoIndex === -1) {
                display.textContent = 'Seleccionar horario';
            } else {
                const selectedBingo = dailySchedule[selectedBingoIndex];
                display.textContent = `${selectedBingo.label} - Ronda ${currentRound}`;
            }
        }

        // Agregar nuevo horario
        function addNewSchedule() {
            const timeInput = document.getElementById('new-time');
            const time = timeInput.value;
            
            if (!time) {
                showPopup('Error', 'Selecciona una hora válida');
                return;
            }
            
            const [hours, minutes] = time.split(':');
            const label = formatTime(hours, minutes);
            
            dailySchedule.push({
                time: time,
                label: label,
                completed: false
            });
            
            timeInput.value = '';
            renderSchedule();
            showPopup('Horario Agregado', `Nuevo bingo programado para las ${label}`);
        }

        // Eliminar horario
        function deleteSchedule(index) {
            if (dailySchedule.length <= 1) {
                showPopup('Error', 'Debe haber al menos un horario');
                return;
            }
            
            const bingo = dailySchedule[index];
            dailySchedule.splice(index, 1);
            
            if (selectedBingoIndex === index) {
                selectedBingoIndex = -1;
                document.getElementById('start-round').disabled = true;
            } else if (selectedBingoIndex > index) {
                selectedBingoIndex--;
            }
            
            renderSchedule();
            showPopup('Horario Eliminado', `Bingo de las ${bingo.label} eliminado`);
        }

        // Formatear hora
        function formatTime(hours, minutes) {
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        // Funciones para controlar el juego
        function saveGameState() {
            const currentGameState = localStorage.getItem('bingoGameState');
            let gameStartTime = Date.now();
            
            if (currentGameState) {
                const parsed = JSON.parse(currentGameState);
                gameStartTime = parsed.gameStartTime || Date.now();
            }
            
            const gameState = {
                gameActive: gameActive,
                currentRound: currentRound,
                selectedBingoIndex: selectedBingoIndex,
                roundPrize: ticketsSoldToday * 60 * 0.375,
                calledNumbers: calledNumbers,
                gameStartTime: gameStartTime,
                timestamp: Date.now()
            };
            localStorage.setItem('bingoGameState', JSON.stringify(gameState));
        }

        function startAutomaticCalling() {
            calledNumbers = []; // Limpiar números anteriores
            const gameStartTime = Date.now();
            
            // Seleccionar patrón aleatorio para ronda 1
            if (currentRound === 1) {
                currentPattern = bingoPatterns[Math.floor(Math.random() * bingoPatterns.length)];
            } else {
                currentPattern = null; // Ronda 2 es bingo completo
            }
            
            // Guardar tiempo de inicio
            const gameState = {
                gameActive: gameActive,
                currentRound: currentRound,
                selectedBingoIndex: selectedBingoIndex,
                roundPrize: ticketsSoldToday * 60 * 0.375,
                calledNumbers: calledNumbers,
                gameStartTime: gameStartTime,
                currentPattern: currentPattern,
                timestamp: gameStartTime
            };
            localStorage.setItem('bingoGameState', JSON.stringify(gameState));
            
            // Cantar números cada 4 segundos
            callingInterval = setInterval(() => {
                if (!gameActive) {
                    stopAutomaticCalling();
                    return;
                }
                
                const availableNumbers = [];
                for (let i = 1; i <= 75; i++) {
                    if (!calledNumbers.find(item => item.number === i)) {
                        availableNumbers.push(i);
                    }
                }
                
                if (availableNumbers.length === 0) {
                    showPopup('Juego Terminado', 'Todos los números han sido cantados');
                    stopAutomaticCalling();
                    return;
                }
                
                const randomNumber = availableNumbers[Math.floor(Math.random() * availableNumbers.length)];
                
                // Guardar número con timestamp
                const numberData = {
                    number: randomNumber,
                    timestamp: Date.now(),
                    timeFromStart: Date.now() - gameStartTime
                };
                
                calledNumbers.push(numberData);
                saveGameState();
                
            }, 4000); // Cada 4 segundos
        }

        function stopAutomaticCalling() {
            if (callingInterval) {
                clearInterval(callingInterval);
                callingInterval = null;
            }
        }

        function getBingoLetter(number) {
            if (number >= 1 && number <= 15) return 'B';
            if (number >= 16 && number <= 30) return 'I';
            if (number >= 31 && number <= 45) return 'N';
            if (number >= 46 && number <= 60) return 'G';
            if (number >= 61 && number <= 75) return 'O';
            return '';
        }

        // Actualizar stats cada 10 segundos
        setInterval(updateStats, 10000);
        
        // Buscar usuario
        function searchUser() {
            const phone = document.getElementById('user-phone-search').value.trim();
            if (!phone) {
                showPopup('Error', 'Ingresa un número de teléfono');
                return;
            }
            
            const userProfile = getUserProfile(phone);
            if (userProfile) {
                displayUserProfile(userProfile);
            } else {
                showPopup('Usuario no encontrado', 'No se encontraron registros para este teléfono');
                document.getElementById('user-profile').style.display = 'none';
            }
        }
        
        // Obtener perfil del usuario
        function getUserProfile(phone) {
            const allPurchases = [...allPayments];
            const userPurchases = allPurchases.filter(p => p.phone === phone);
            
            if (userPurchases.length === 0) return null;
            
            // Obtener cartones del usuario (simulado por teléfono)
            const userCards = getUserCards(phone);
            
            const totalSpent = userPurchases.reduce((sum, p) => p.status === 'verified' ? sum + p.amount : sum, 0);
            const totalCards = userPurchases.reduce((sum, p) => p.status === 'verified' ? sum + p.cartones : sum, 0);
            const vigentCards = userCards.filter(c => c.status === 'vigente').length;
            const enUsoCards = userCards.filter(c => c.status === 'en_uso').length;
            const vencidoCards = userCards.filter(c => c.status === 'vencido').length;
            
            return {
                phone: phone,
                firstPurchase: userPurchases[0].date,
                totalPurchases: userPurchases.length,
                totalSpent: totalSpent,
                totalCards: totalCards,
                vigentCards: vigentCards,
                enUsoCards: enUsoCards,
                vencidoCards: vencidoCards,
                purchases: userPurchases.sort((a, b) => new Date(b.date) - new Date(a.date)),
                lastActivity: userPurchases[userPurchases.length - 1].date
            };
        }
        
        // Simular cartones del usuario
        function getUserCards(phone) {
            // En producción esto vendría de una base de datos
            // Por ahora simulamos algunos cartones
            return [
                { id: 'A1B2C', status: 'vigente', purchaseDate: '2024-01-15' },
                { id: 'D3E4F', status: 'vigente', purchaseDate: '2024-01-15' },
                { id: 'G5H6I', status: 'vencido', purchaseDate: '2024-01-14' },
                { id: 'J7K8L', status: 'vencido', purchaseDate: '2024-01-14' }
            ];
        }
        
        // Mostrar perfil del usuario
        function displayUserProfile(profile) {
            const container = document.getElementById('user-profile');
            container.style.display = 'block';
            
            container.innerHTML = `
                <h4 style="margin: 0 0 1rem 0; color: var(--accent-color);">Usuario: ${profile.phone}</h4>
                
                <div class="user-info">
                    <div><strong>Registro:</strong> ${profile.firstPurchase}</div>
                    <div><strong>Última actividad:</strong> ${profile.lastActivity}</div>
                </div>
                
                <div class="user-cards-grid">
                    <div class="user-stat">
                        <span class="user-stat-number">${profile.totalCards}</span>
                        <span class="user-stat-label">Total Comprados</span>
                    </div>
                    <div class="user-stat">
                        <span class="user-stat-number">${profile.vigentCards}</span>
                        <span class="user-stat-label">Vigentes</span>
                    </div>
                    <div class="user-stat">
                        <span class="user-stat-number">${profile.enUsoCards}</span>
                        <span class="user-stat-label">En Uso</span>
                    </div>
                    <div class="user-stat">
                        <span class="user-stat-number">${profile.vencidoCards}</span>
                        <span class="user-stat-label">Vencidos</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                    <div class="user-stat">
                        <span class="user-stat-number">${profile.totalPurchases}</span>
                        <span class="user-stat-label">Compras Realizadas</span>
                    </div>
                    <div class="user-stat">
                        <span class="user-stat-number">BsF ${profile.totalSpent}</span>
                        <span class="user-stat-label">Total Gastado</span>
                    </div>
                </div>
                
                <h5 style="margin: 1rem 0 0.5rem 0;">Historial de Compras:</h5>
                <div class="user-history">
                    ${profile.purchases.map(purchase => `
                        <div class="history-item">
                            <div class="history-date">${purchase.date} - Ref: ${purchase.ref}</div>
                            <div>${purchase.cartones} cartones - BsF ${purchase.amount} - 
                                <span style="color: ${purchase.status === 'verified' ? '#28a745' : purchase.status === 'rejected' ? '#dc3545' : '#ffc107'}">
                                    ${purchase.status.toUpperCase()}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Permitir buscar con Enter
        document.getElementById('user-phone-search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchUser();
            }
        });
    </script>
</body>
</html>