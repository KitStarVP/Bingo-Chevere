<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Bingo Ch√©vere</title>
    <link rel="stylesheet" href="css/landing.css">
    <link rel="stylesheet" href="css/new-nav.css">
    <link rel="stylesheet" href="css/popup.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="main-container">
        <header class="landing-header">
            <div class="logo">
                <span class="logo-main">ADMIN</span>
                <span class="logo-tagline">Panel</span>
            </div>
        </header>

        <main class="admin-section">
            <!-- CALENDARIO SEMANAL MEJORADO -->
            <div class="admin-card">
                <h2>üìÖ Programaci√≥n Semanal</h2>
                
                <!-- Panel de Control Visual -->
                <div class="current-bingo-display" id="current-bingo-display" style="display: none;">
                    <div class="active-bingo-header">
                        <h3 id="active-bingo-title">üéØ BINGO ACTIVO</h3>
                        <div class="bingo-status" id="bingo-status">üîµ EN CURSO</div>
                    </div>
                    <div class="bingo-stats">
                        <div class="stat"><span>Tiempo:</span> <span id="game-time">00:00</span></div>
                        <div class="stat"><span>N√∫meros:</span> <span id="numbers-count">0/75</span></div>
                        <div class="stat"><span>Ronda:</span> <span id="round-display">1/2</span></div>
                        <div class="stat"><span>Cartones:</span> <span id="active-cards">0</span></div>
                    </div>
                </div>
                
                <!-- Calendario Semanal -->
                <div class="weekly-calendar">
                    <div class="calendar-header">
                        <button id="prev-week" class="week-nav">‚Üê</button>
                        <span id="week-display">Semana del 15-21 Enero</span>
                        <button id="next-week" class="week-nav">‚Üí</button>
                    </div>
                    
                    <div class="days-grid" id="days-grid">
                        <!-- D√≠as se generar√°n din√°micamente -->
                    </div>
                </div>
                
                <!-- Bingos Especiales -->
                <div class="special-bingos">
                    <h4>‚ú® Bingos Especiales</h4>
                    <div class="special-list" id="special-list">
                        <!-- Bingos especiales -->
                    </div>
                    <button id="add-special" class="admin-btn small">‚ûï Agregar Especial</button>
                </div>
            </div>
            
            <!-- CONTROLES DE JUEGO AVANZADOS -->
            <div class="admin-card">
                <h2>üéÆ Controles del Juego</h2>
                
                <div class="game-controls" id="game-controls">
                    <div class="control-section">
                        <h4>Selecci√≥n de Bingo:</h4>
                        <select id="bingo-selector" class="bingo-select">
                            <option value="">Seleccionar bingo...</option>
                        </select>
                        <button id="start-instant-bingo" class="admin-btn warning" style="width: 100%; margin-top: 0.5rem;">‚ö° Iniciar Bingo Instant√°neo</button>
                    </div>
                    
                    <div class="control-buttons" id="control-buttons">
                        <button id="start-round" class="control-btn start" disabled>‚ñ∂Ô∏è Iniciar Ronda</button>
                        <button id="pause-round" class="control-btn pause" style="display: none;">‚è∏Ô∏è Pausar</button>
                        <button id="resume-round" class="control-btn resume" style="display: none;">‚ñ∂Ô∏è Reanudar</button>
                        <button id="end-round" class="control-btn end">‚èπÔ∏è Finalizar Ronda</button>
                    </div>
                    
                    <div class="critical-actions">
                        <h4>‚ö†Ô∏è Acciones Cr√≠ticas:</h4>
                        <button id="cancel-bingo" class="control-btn cancel">üõë Cancelar Bingo</button>
                        <button id="reset-system" class="control-btn reset">üîÑ Reset Sistema</button>
                    </div>
                </div>
            </div>
            
            <!-- CONFIGURACI√ìN DEL DOMINIO -->
            <div class="admin-card">
                <h2>üåê Configuraci√≥n del Dominio</h2>
                <div class="domain-config">
                    <label for="domain-input">Dominio del Bingo:</label>
                    <input type="text" id="domain-input" placeholder="Ej: mi-bingo.com" value="">
                    <button id="save-domain" class="admin-btn primary">üíæ Guardar Dominio</button>
                    <p class="domain-status" id="domain-status">Sin dominio configurado</p>
                </div>
            </div>

            <!-- PANEL DE COMUNICACI√ìN -->
            <div class="admin-card">
                <h2>üì± Panel de Comunicaci√≥n</h2>
                
                <div class="notification-templates">
                    <h4>Mensajes Predefinidos:</h4>
                    <div class="message-template" data-message-template="üéØüî• ¬°BINGO EN 30 MINUTOS! üî•üéØ\n\nüí∞ ¬°Compra tus cartones YA en {DOMAIN}! üí∞\n\n‚ö° ¬°No te quedes sin jugar! ‚ö°">
                        <span>Bingo en 30 minutos</span>
                        <button class="share-whatsapp">üì± Compartir</button>
                    </div>
                    <div class="message-template" data-message-template="‚è∞üö® ¬°√öLTIMOS 10 MINUTOS! üö®‚è∞\n\nüé´ √öltimos cartones disponibles üé´\n\nüèÉ‚Äç‚ôÇÔ∏èüí® ¬°CORRE QUE SE ACABA! üí®üèÉ‚Äç‚ôÄÔ∏è">
                        <span>√öltimos 10 minutos</span>
                        <button class="share-whatsapp">üì± Compartir</button>
                    </div>
                    <div class="message-template" data-message-template="üöÄüéâ ¬°BINGO INICIADO! üéâüöÄ\n\nüî¥ EN VIVO AHORA üî¥\n\nüëÜ Entra YA a {DOMAIN} üëÜ\n\nüéØ ¬°QUE COMIENCE LA DIVERSI√ìN! üéØ">
                        <span>Bingo iniciado</span>
                        <button class="share-whatsapp">üì± Compartir</button>
                    </div>
                    <div class="message-template" data-message-template="üîÑüìÖ BINGO REPROGRAMADO üìÖüîÑ\n\n‚úÖ Tus cartones siguen v√°lidos ‚úÖ\n\n‚è∞ Nuevo horario pr√≥ximamente ‚è∞\n\nüí™ ¬°Mantente atento! üí™">
                        <span>Bingo reprogramado</span>
                        <button class="share-whatsapp">üì± Compartir</button>
                    </div>
                </div>
                
                <div class="custom-message">
                    <h4>Mensaje Personalizado:</h4>
                    <textarea id="custom-message-text" placeholder="Escribe tu mensaje personalizado..."></textarea>
                    <button id="share-custom" class="admin-btn primary">üì± Compartir Personalizado</button>
                </div>
                
                <div class="notification-history">
                    <h4>Historial de Notificaciones:</h4>
                    <div id="notification-log" class="notification-log">
                        <!-- Historial se mostrar√° aqu√≠ -->
                    </div>
                </div>
            </div>

            <!-- VERIFICACI√ìN DE CARTONES -->
            <div class="admin-card">
                <h2>üéØ Verificaci√≥n de Cartones</h2>
                <div id="bingo-verification" class="verification-section">
                    <div id="no-bingo-pending" class="no-bingo-msg">
                        <p>No hay BINGO pendiente de verificaci√≥n</p>
                    </div>
                    <div id="bingo-pending" class="bingo-pending" style="display: none;">
                        <div class="bingo-alert">
                            <h3>üö® ¬°BINGO CANTADO!</h3>
                            <p>Un jugador ha cantado BINGO</p>
                            <div class="bingo-details">
                                <span>Cart√≥n: <strong id="winner-carton">-</strong></span>
                                <span>Tel√©fono: <strong id="winner-phone">-</strong></span>
                                <span>Tipo: <strong id="winner-type">-</strong></span>
                            </div>
                        </div>
                        <div class="verification-actions">
                            <button id="verify-winner" class="admin-btn primary">‚úì Verificar Ganador</button>
                            <button id="reject-winner" class="admin-btn danger">‚úó Rechazar</button>
                        </div>
                    </div>
                </div>
                
                <!-- Historial de Ganadores -->
                <div class="winners-history">
                    <h4>üìã √öltimos Ganadores</h4>
                    <div class="search-winners">
                        <input type="date" id="winner-date-filter" placeholder="Fecha">
                        <input type="tel" id="winner-phone-filter" placeholder="Tel√©fono">
                        <button onclick="filterWinners()" class="admin-btn small">Buscar</button>
                    </div>
                    <div id="winners-list" class="winners-list">
                        <!-- Lista de ganadores -->
                    </div>
                </div>
            </div>

            <div class="admin-card">
                <h2>Gesti√≥n de Pagos</h2>
                <div class="payment-stats">
                    <div class="payment-stat" onclick="showPayments('pending')">
                        <span class="stat-number" id="pending-count">0</span>
                        <span class="stat-label">Pendientes</span>
                    </div>
                    <div class="payment-stat" onclick="showPayments('verified')">
                        <span class="stat-number" id="verified-count">0</span>
                        <span class="stat-label">Verificados</span>
                    </div>
                    <div class="payment-stat" onclick="showPayments('rejected')">
                        <span class="stat-number" id="rejected-count">0</span>
                        <span class="stat-label">Rechazados</span>
                    </div>
                </div>
                
                <div id="payment-modal" class="payment-modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="modal-title">Pagos</h3>
                            <button class="close-modal" onclick="closePaymentModal()">√ó</button>
                        </div>
                        <div class="search-filters">
                            <input type="date" id="date-filter" placeholder="Fecha">
                            <input type="tel" id="phone-filter" placeholder="Tel√©fono">
                            <button onclick="filterPayments()">Buscar</button>
                        </div>
                        <div id="payments-list" class="payments-list">
                            <!-- Pagos se cargar√°n aqu√≠ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- GESTI√ìN DE PREMIOS -->
            <div class="admin-card">
                <h2>üí∞ Gesti√≥n de Premios</h2>
                <div class="prize-stats">
                    <div class="prize-stat">
                        <span class="stat-number" id="pending-prizes">0</span>
                        <span class="stat-label">Pendientes</span>
                    </div>
                    <div class="prize-stat">
                        <span class="stat-number" id="paid-prizes">0</span>
                        <span class="stat-label">Pagados</span>
                    </div>
                    <div class="prize-stat">
                        <span class="stat-number" id="total-pending">BsF 0</span>
                        <span class="stat-label">Total Pendiente</span>
                    </div>
                </div>
                
                <!-- Pesta√±as de Premios -->
                <div class="prize-tabs">
                    <button class="tab-btn active" onclick="showPrizeTab('pending')">Pendientes</button>
                    <button class="tab-btn" onclick="showPrizeTab('paid')">Pagados</button>
                </div>
                
                <div id="prizes-content" class="prizes-content">
                    <!-- Contenido de premios -->
                </div>
            </div>

            <div class="admin-card">
                <h2>üë• Gesti√≥n de Usuarios</h2>
                <div class="user-search">
                    <select id="user-dropdown" onchange="selectUserFromDropdown()">
                        <option value="">Seleccionar jugador...</option>
                    </select>
                    <span style="margin: 0 0.5rem; color: #666;">o</span>
                    <input type="tel" id="user-phone-search" placeholder="Buscar por tel√©fono">
                    <button onclick="searchUser()" class="admin-btn small">Buscar</button>
                    <button onclick="loadAllUsers(true)" class="admin-btn small">Actualizar Lista</button>
                </div>
                
                <!-- Estad√≠sticas de Usuarios -->
                <div class="users-stats">
                    <div class="user-stat-box">
                        <span class="stat-number" id="total-users">0</span>
                        <span class="stat-label">Usuarios Registrados</span>
                    </div>
                    <div class="user-stat-box">
                        <span class="stat-number" id="active-users">0</span>
                        <span class="stat-label">Usuarios Activos</span>
                    </div>
                    <div class="user-stat-box">
                        <span class="stat-number" id="vip-users">0</span>
                        <span class="stat-label">Usuarios VIP</span>
                    </div>
                </div>
                
                <div id="user-profile" class="user-profile" style="display: none;">
                    <!-- Perfil del usuario se cargar√° aqu√≠ -->
                </div>
            </div>

            <!-- LIMPIEZA SELECTIVA DE BASE DE DATOS -->
            <div class="admin-card">
                <h2>üßπ Limpieza del Sistema</h2>
                <div class="clean-zone">
                    <p style="color: #28a745; font-weight: 600; text-align: center; margin-bottom: 0.5rem;">
                        üìù Limpieza Selectiva
                    </p>
                    <p style="font-size: 0.8rem; color: #666; text-align: center; margin-bottom: 1rem;">
                        Selecciona qu√© datos limpiar para dejar el sistema como nuevo
                    </p>
                    <button id="open-clean-modal" class="admin-btn primary" style="width: 100%;">
                        üßπ ABRIR PANEL DE LIMPIEZA
                    </button>
                </div>
            </div>
            
            <!-- Modal de Limpieza Selectiva -->
            <div id="clean-modal" class="clean-modal" style="display: none;">
                <div class="clean-modal-content">
                    <div class="clean-modal-header">
                        <h3>üßπ Limpieza Selectiva del Sistema</h3>
                        <button class="close-clean-modal" onclick="closeCleanModal()">&times;</button>
                    </div>
                    
                    <div class="clean-categories">
                        <div class="clean-category">
                            <h4>üéÆ Datos del Juego</h4>
                            <label><input type="checkbox" id="clean-gamestate"> Estado del juego actual (n√∫meros cantados, rondas)</label>
                            <label><input type="checkbox" id="clean-winners"> Ganadores y premios</label>
                            <label><input type="checkbox" id="clean-schedules"> Horarios completados</label>
                            <label><input type="checkbox" id="clean-patterns"> Patrones de juego</label>
                        </div>
                        
                        <div class="clean-category">
                            <h4>üí∞ Datos Financieros</h4>
                            <label><input type="checkbox" id="clean-pending"> Compras pendientes</label>
                            <label><input type="checkbox" id="clean-verified"> Compras verificadas</label>
                            <label><input type="checkbox" id="clean-rejected"> Compras rechazadas</label>
                            <label><input type="checkbox" id="clean-stats"> Estad√≠sticas de ventas</label>
                        </div>
                        
                        <div class="clean-category">
                            <h4>üé´ Datos de Jugadores</h4>
                            <label><input type="checkbox" id="clean-cards"> Todos los cartones de jugadores</label>
                            <label><input type="checkbox" id="clean-profiles"> Perfiles de usuarios</label>
                            <label><input type="checkbox" id="clean-sessions"> Sesiones activas</label>
                        </div>
                        
                        <div class="clean-category">
                            <h4>üîÑ Configuraci√≥n del Sistema</h4>
                            <label><input type="checkbox" id="clean-cache"> Cach√© del navegador</label>
                            <label><input type="checkbox" id="clean-alerts"> Alertas y notificaciones</label>
                            <label><input type="checkbox" id="clean-logs"> Logs del sistema</label>
                        </div>
                        
                        <div class="clean-category danger-category">
                            <h4>‚ö†Ô∏è Limpieza Total</h4>
                            <label><input type="checkbox" id="clean-all"> üóëÔ∏è ELIMINAR TODO (selecciona todas las opciones)</label>
                        </div>
                    </div>
                    
                    <div class="clean-actions">
                        <button onclick="selectAllClean()" class="admin-btn secondary">Seleccionar Todo</button>
                        <button onclick="clearAllClean()" class="admin-btn secondary">Limpiar Selecci√≥n</button>
                        <button onclick="closeCleanModal()" class="admin-btn">Cancelar</button>
                        <button onclick="executeClean()" class="admin-btn danger">Ejecutar Limpieza</button>
                    </div>
                </div>
            </div>

            <div class="admin-card">
                <h2>Estad√≠sticas</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Ronda Actual</span>
                        <span id="current-round" class="stat-value">1 de 2</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Cartones Vendidos</span>
                        <span id="tickets-sold" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Premio Ronda</span>
                        <span id="round-prize" class="stat-value">BsF 0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Premio Total Hoy</span>
                        <span id="daily-total" class="stat-value">BsF 0</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <nav class="new-bottom-nav">
        <a href="index.html" class="new-nav-item">
            <svg class="new-nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <span class="new-nav-label">Inicio</span>
        </a>
        <a href="comprar-cartones.html" class="new-nav-item">
            <svg class="new-nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"></path><path d="M13 5v2"></path><path d="M13 17v2"></path><path d="M13 11v2"></path></svg>
            <span class="new-nav-label">Cartones</span>
        </a>
        <a href="sala-de-juego.html" class="new-nav-item">
            <svg class="new-nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            <span class="new-nav-label">Jugar</span>
        </a>
        <a href="premios.html" class="new-nav-item">
            <svg class="new-nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C17.15 18.75 18 20.24 18 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>
            <span class="new-nav-label">Premios</span>
        </a>
        <a href="perfil.html" class="new-nav-item">
            <svg class="new-nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <span class="new-nav-label">Perfil</span>
        </a>
    </nav>

    <style>
        .admin-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 500px;
            padding-bottom: 2rem;
        }

        .admin-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .admin-card h2 {
            margin: 0 0 1rem 0;
            color: var(--accent-color);
            font-size: 1.1rem;
            text-align: center;
        }

        .admin-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .admin-btn {
            padding: 0.7rem 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .admin-btn.primary {
            background: #28a745;
            color: white;
        }

        .admin-btn.secondary {
            background: #ffc107;
            color: #212529;
        }

        .admin-btn.danger {
            background: #dc3545;
            color: white;
        }

        .admin-btn.warning {
            background: #fd7e14;
            color: white;
        }

        .admin-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .payments-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .payment-actions {
            display: flex;
            gap: 0.3rem;
        }

        .payment-btn {
            padding: 0.3rem 0.6rem;
            border: none;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .approve-btn {
            background: #28a745;
            color: white;
        }

        .reject-btn {
            background: #dc3545;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }


        
        .schedule-info {
            text-align: center;
            margin-bottom: 1rem;
        }

        .current-bingo {
            background: #e8f0fe;
            padding: 0.5rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .schedule-times {
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
        }

        .time-slot {
            background: #f8f9fa;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .time-slot.active {
            background: var(--accent-color);
            color: white;
        }

        .time-slot.selected {
            background: #28a745;
            color: white;
        }

        .delete-time {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .schedule-management {
            margin: 0.5rem 0;
        }

        .add-schedule {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
        }

        #new-time {
            padding: 0.4rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .admin-btn.small {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        .payment-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .payment-stat {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .payment-stat:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .stat-number {
            display: block;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .stat-label {
            font-size: 0.7rem;
            color: #666;
        }

        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--accent-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .search-filters {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .search-filters input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .search-filters button {
            padding: 0.5rem 1rem;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .payments-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 1rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .user-cards-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
        }

        .stat-value {
            font-weight: bold;
            color: var(--accent-color);
        }

        .user-search {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .users-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .user-stat-box {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .user-stat-box .stat-number {
            display: block;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .user-stat-box .stat-label {
            font-size: 0.7rem;
            color: #666;
        }
        
        .user-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        .user-action-btn {
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .user-action-btn.edit {
            background: #17a2b8;
            color: white;
        }
        
        .user-action-btn.reset-pin {
            background: #ffc107;
            color: #212529;
        }
        
        .user-action-btn.block {
            background: #dc3545;
            color: white;
        }
        
        .user-action-btn.unblock {
            background: #28a745;
            color: white;
        }
        
        .user-action-btn.delete {
            background: #6c757d;
            color: white;
        }
        
        .user-action-btn.gift {
            background: #fd7e14;
            color: white;
        }
        
        .user-level {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .user-level.normal {
            background: #e9ecef;
            color: #495057;
        }
        
        .user-level.active {
            background: #d4edda;
            color: #155724;
        }
        
        .user-level.vip {
            background: #fff3cd;
            color: #856404;
        }
        
        .user-level.premium {
            background: #f8d7da;
            color: #721c24;
        }
        
        .user-activity {
            max-height: 150px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .activity-item {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 0.3rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid #eee;
        }
        
        .activity-date {
            font-weight: bold;
            color: var(--accent-color);
        }

        .user-search select {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
        }

        .user-search input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .user-profile {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
        }

        .user-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .user-stat {
            background: white;
            padding: 0.5rem;
            border-radius: 4px;
            text-align: center;
        }

        .user-stat-number {
            display: block;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .user-stat-label {
            font-size: 0.7rem;
            color: #666;
        }

        .user-history {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            background: white;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .history-date {
            font-weight: bold;
            color: var(--accent-color);
        }

        /* ESTILOS PARA VERIFICACI√ìN DE CARTONES */
        .verification-section {
            margin-bottom: 1rem;
        }

        .no-bingo-msg {
            text-align: center;
            color: #666;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .bingo-pending {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 1rem;
        }

        .bingo-alert {
            text-align: center;
            margin-bottom: 1rem;
        }

        .bingo-alert h3 {
            margin: 0 0 0.5rem 0;
            color: #dc3545;
            font-size: 1.2rem;
        }

        .bingo-details {
            display: flex;
            justify-content: space-around;
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        .verification-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .winners-history {
            margin-top: 1rem;
            border-top: 1px solid #eee;
            padding-top: 1rem;
        }

        .winners-history h4 {
            margin: 0 0 0.5rem 0;
            color: var(--accent-color);
            font-size: 1rem;
        }

        .search-winners {
            display: flex;
            gap: 0.3rem;
            margin-bottom: 0.5rem;
        }

        .search-winners input {
            flex: 1;
            padding: 0.4rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .winners-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .winner-item {
            background: #f8f9fa;
            padding: 0.5rem;
            margin-bottom: 0.3rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .winner-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            color: var(--accent-color);
        }

        .winner-details {
            font-size: 0.7rem;
            color: #666;
            margin-top: 0.2rem;
        }

        /* ESTILOS PARA GESTI√ìN DE PREMIOS */
        .prize-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .prize-stat {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
        }

        .prize-tabs {
            display: flex;
            margin-bottom: 1rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            font-size: 0.9rem;
        }

        .tab-btn.active {
            background: var(--accent-color);
            color: white;
        }

        .prizes-content {
            max-height: 300px;
            overflow-y: auto;
        }

        .prize-item {
            background: #f8f9fa;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }

        .prize-item.paid {
            border-left-color: #6c757d;
            opacity: 0.8;
        }

        .prize-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.3rem;
        }

        .prize-info {
            font-size: 0.8rem;
            color: #666;
        }

        .prize-amount {
            font-weight: bold;
            color: #28a745;
            font-size: 1rem;
        }

        .prize-actions {
            margin-top: 0.5rem;
        }

        .pay-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .paid-badge {
            background: #6c757d;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
        }
        
        /* ESTILOS PARA MODAL DE LIMPIEZA */
        .clean-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .clean-modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .clean-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }
        
        .clean-modal-header h3 {
            margin: 0;
            color: var(--accent-color);
            font-size: 1.1rem;
        }
        
        .close-clean-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .clean-categories {
            padding: 1rem;
        }
        
        .clean-category {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }
        
        .clean-category.danger-category {
            background: #fff5f5;
            border-left-color: #dc3545;
        }
        
        .clean-category h4 {
            margin: 0 0 0.75rem 0;
            color: var(--accent-color);
            font-size: 0.95rem;
        }
        
        .danger-category h4 {
            color: #dc3545;
        }
        
        .clean-category label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            cursor: pointer;
            padding: 0.3rem 0;
        }
        
        .clean-category input[type="checkbox"] {
            margin-right: 0.5rem;
            transform: scale(1.1);
        }
        
        .clean-actions {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
            flex-wrap: wrap;
        }
        
        .clean-actions button {
            flex: 1;
            min-width: 120px;
            padding: 0.6rem;
            font-size: 0.8rem;
        }
        
        @media (max-width: 600px) {
            .clean-modal {
                padding: 0.5rem;
            }
            
            .clean-actions {
                flex-direction: column;
            }
            
            .clean-actions button {
                width: 100%;
            }
        }
        
        /* ESTILOS PARA CALENDARIO SEMANAL */
        .current-bingo-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .active-bingo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .active-bingo-header h3 {
            margin: 0;
            font-size: 1rem;
        }
        
        .bingo-status {
            background: rgba(255,255,255,0.2);
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        .bingo-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        
        .bingo-stats .stat {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }
        
        .weekly-calendar {
            margin-bottom: 1rem;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .week-nav {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.3rem;
        }
        
        .day-column {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 0.3rem;
            min-height: 80px;
        }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.3rem;
        }
        
        .day-header h4 {
            margin: 0;
            font-size: 0.7rem;
            color: var(--accent-color);
        }
        
        .add-bingo-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .bingo-card {
            background: white;
            border-radius: 4px;
            padding: 0.3rem;
            margin-bottom: 0.2rem;
            font-size: 0.6rem;
            border-left: 3px solid #28a745;
        }
        
        .bingo-card.active {
            border-left-color: #007bff;
        }
        
        .bingo-card.completed {
            border-left-color: #6c757d;
            opacity: 0.7;
        }
        
        .bingo-card.cancelled {
            border-left-color: #dc3545;
        }
        
        .bingo-time {
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .bingo-status {
            font-size: 0.5rem;
            margin: 0.1rem 0;
        }
        
        .bingo-config {
            font-size: 0.5rem;
            color: #666;
        }
        
        .bingo-actions {
            display: flex;
            gap: 0.2rem;
            margin-top: 0.2rem;
        }
        
        .edit-btn, .delete-btn {
            background: none;
            border: none;
            font-size: 0.6rem;
            cursor: pointer;
            padding: 0.1rem;
        }
        
        .special-bingos {
            margin-top: 1rem;
            border-top: 1px solid #eee;
            padding-top: 1rem;
        }
        
        .special-bingos h4 {
            margin: 0 0 0.5rem 0;
            color: var(--accent-color);
            font-size: 0.9rem;
        }
        
        .special-bingo {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .special-info strong {
            color: #856404;
        }
        
        .special-details {
            font-size: 0.7rem;
            color: #666;
        }
        
        .special-actions {
            display: flex;
            gap: 0.3rem;
        }
        
        /* CONTROLES DE JUEGO AVANZADOS */
        .game-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .control-section h4 {
            margin: 0 0 0.5rem 0;
            color: var(--accent-color);
            font-size: 0.9rem;
        }
        
        .bingo-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        
        .control-btn {
            padding: 0.7rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }
        
        .control-btn.start {
            background: #28a745;
            color: white;
        }
        
        .control-btn.pause {
            background: #ffc107;
            color: #212529;
        }
        
        .control-btn.resume {
            background: #17a2b8;
            color: white;
        }
        
        .control-btn.end {
            background: #6c757d;
            color: white;
        }
        
        .control-btn.cancel {
            background: #dc3545;
            color: white;
        }
        
        .control-btn.reset {
            background: #fd7e14;
            color: white;
        }
        
        .control-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .critical-actions {
            border-top: 1px solid #eee;
            padding-top: 1rem;
        }
        
        .critical-actions .control-btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        /* PANEL DE COMUNICACI√ìN */
        .notification-templates {
            margin-bottom: 1rem;
        }
        
        .notification-templates h4 {
            margin: 0 0 0.5rem 0;
            color: var(--accent-color);
            font-size: 0.9rem;
        }
        
        .message-template {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 6px;
            margin-bottom: 0.3rem;
        }
        
        .message-template span {
            font-size: 0.8rem;
            color: #333;
        }
        
        .share-whatsapp {
            background: #25d366;
            color: white;
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        
        .custom-message {
            margin-bottom: 1rem;
        }
        
        .custom-message h4 {
            margin: 0 0 0.5rem 0;
            color: var(--accent-color);
            font-size: 0.9rem;
        }
        
        #custom-message-text {
            width: 100%;
            min-height: 60px;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            font-family: inherit;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }
        
        .notification-history h4 {
            margin: 0 0 0.5rem 0;
            color: var(--accent-color);
            font-size: 0.9rem;
        }
        
        .notification-log {
            max-height: 150px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 0.5rem;
        }
        
        .notification-item {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 0.3rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid #eee;
        }
        
        .notification-time {
            font-weight: bold;
            color: var(--accent-color);
        }
        
        /* ESTILOS PARA CONFIGURACI√ìN DE DOMINIO */
        .domain-config {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .domain-config label {
            font-weight: 600;
            color: var(--accent-color);
            font-size: 0.9rem;
        }
        
        .domain-config input {
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .domain-status {
            font-size: 0.8rem;
            color: #666;
            margin: 0;
            padding: 0.3rem;
            background: #f8f9fa;
            border-radius: 4px;
            text-align: center;
        }
        
        .domain-status.configured {
            background: #d4edda;
            color: #155724;
        }
    </style>

    <!-- Firebase Configuration -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAKK_aY4OeEh4NmRIAExKk4T0i7d4Z1_8M",
        authDomain: "bingo-chevere.firebaseapp.com",
        databaseURL: "https://bingo-chevere-default-rtdb.firebaseio.com/",
        projectId: "bingo-chevere",
        storageBucket: "bingo-chevere.firebasestorage.app",
        messagingSenderId: "1057150163831",
        appId: "1:1057150163831:web:0d6e9f70c356ee56b09f72"
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      
      window.firebase = { database, ref, set, get, onValue };
      console.log('Firebase inicializado en admin.html');
    </script>

    <script src="js/popup.js"></script>
    <script src="js/loader.js"></script>
    <script>
        // Sistema de bingos diarios
        // VARIABLES DEL SISTEMA MEJORADO
        let selectedBingoId = null;
        let selectedBingoIndex = -1;
        let currentRound = 1;
        let gameActive = false;
        let gameStartTime = null;
        let gameTimer = null;
        let currentPrizeTab = 'pending';
        let bingoWinners = [];
        let bingoPrizes = [];
        let filteredWinners = [];
        let ticketsSoldToday = 0;
        let dailyPrizeTotal = 0;
        let allPayments = [];
        let currentFilter = 'pending';
        let filteredPayments = [];
        let calledNumbers = [];
        let callingInterval = null;
        let currentPattern = null;
        let currentWeekStart = new Date();
        let notificationHistory = [];
        
        // Horarios diarios (compatibilidad con c√≥digo existente)
        let dailySchedule = [
            { label: '14:00', time: '14:00', completed: false },
            { label: '16:00', time: '16:00', completed: false },
            { label: '18:00', time: '18:00', completed: false },
            { label: '20:00', time: '20:00', completed: false }
        ];
        
        // ESTRUCTURA DE BINGOS SEMANAL
        let weeklySchedule = {
            monday: [],
            tuesday: [],
            wednesday: [],
            thursday: [],
            friday: [],
            saturday: [],
            sunday: []
        };
        
        // BINGOS ESPECIALES
        let specialBingos = [
            {
                id: 'christmas',
                date: '2024-12-25',
                time: '20:00',
                name: 'Bingo Navide√±o',
                price: 150,
                multiplier: 3,
                maxCards: 5,
                status: 'programmed'
            },
            {
                id: 'newyear',
                date: '2024-12-31',
                time: '23:00',
                name: 'Bingo A√±o Nuevo',
                price: 200,
                multiplier: 5,
                maxCards: 3,
                status: 'programmed'
            }
        ];
        
        // CONFIGURACIONES POR DEFECTO
        const bingoTemplates = {
            normal: { price: 60, multiplier: 1, maxCards: 10, duration: 45 },
            premium: { price: 100, multiplier: 2, maxCards: 5, duration: 60 },
            familiar: { price: 40, multiplier: 1, maxCards: 3, duration: 30 },
            especial: { price: 150, multiplier: 3, maxCards: 5, duration: 75 }
        };
        
        // Patrones √∫nicos y complicados
        const bingoPatterns = [
            {
                name: "Cruz Diagonal",
                description: "Ambas diagonales completas",
                positions: [[0,0],[1,1],[2,2],[3,3],[4,4],[0,4],[1,3],[2,2],[3,1],[4,0]]
            },
            {
                name: "Marcos Dobles",
                description: "Bordes exteriores e interiores",
                positions: [[0,0],[0,1],[0,2],[0,3],[0,4],[1,0],[1,4],[2,0],[2,4],[3,0],[3,4],[4,0],[4,1],[4,2],[4,3],[4,4],[1,1],[1,2],[1,3],[2,1],[2,3],[3,1],[3,2],[3,3]]
            },
            {
                name: "Estrella de 8 Puntas",
                description: "Patr√≥n de estrella compleja",
                positions: [[0,2],[1,1],[1,3],[2,0],[2,2],[2,4],[3,1],[3,3],[4,2],[1,0],[1,4],[0,1],[0,3],[3,0],[3,4],[4,1],[4,3]]
            },
            {
                name: "Espiral Completa",
                description: "Espiral desde esquina",
                positions: [[0,0],[0,1],[0,2],[0,3],[0,4],[1,4],[2,4],[3,4],[4,4],[4,3],[4,2],[4,1],[4,0],[3,0],[2,0],[1,0],[1,1],[1,2],[1,3],[2,3],[3,3],[3,2],[3,1],[2,1],[2,2]]
            },
            {
                name: "Diamante Expandido",
                description: "Diamante con extensiones",
                positions: [[0,2],[1,1],[1,2],[1,3],[2,0],[2,1],[2,2],[2,3],[2,4],[3,1],[3,2],[3,3],[4,2],[0,1],[0,3],[1,0],[1,4],[3,0],[3,4],[4,1],[4,3]]
            },
            {
                name: "Zigzag Completo",
                description: "Patr√≥n zigzag por todo el cart√≥n",
                positions: [[0,0],[0,2],[0,4],[1,1],[1,3],[2,0],[2,2],[2,4],[3,1],[3,3],[4,0],[4,2],[4,4]]
            },
            {
                name: "Cuadrados Anidados",
                description: "Tres cuadrados conc√©ntricos",
                positions: [[0,0],[0,1],[0,2],[0,3],[0,4],[1,0],[1,4],[2,0],[2,4],[3,0],[3,4],[4,0],[4,1],[4,2],[4,3],[4,4],[1,1],[1,2],[1,3],[2,1],[2,3],[3,1],[3,2],[3,3]]
            },
            {
                name: "Flecha Doble",
                description: "Dos flechas apuntando al centro",
                positions: [[0,0],[0,4],[1,1],[1,3],[2,2],[3,1],[3,3],[4,0],[4,4],[1,0],[1,4],[2,1],[2,3],[3,0],[3,4]]
            }
        ];

        // Inicializar panel
        document.addEventListener('DOMContentLoaded', () => {
            // Esperar a que Firebase est√© disponible
            setTimeout(() => {
                try {
                    if (window.firebase) {
                        loadInitialAdminState();
                        loadPurchasesFromFirebase();
                        loadWinnersFromFirebase();
                        loadAllUsers(false);
                    }
                    
                    updatePaymentStats();
                    updateStats();
                    initializeVerificationSystem();
                    initializeNewSystem();
                    
                    // Actualizar pagos cada 2 segundos
                    setInterval(() => {
                        if (window.firebase) {
                            loadPurchasesFromFirebase();
                        }
                        updatePaymentStats();
                    }, 2000);
                    
                    // Verificar BINGO pendiente cada segundo
                    setInterval(checkPendingBingo, 1000);
                } catch (error) {
                    console.error('Error en inicializaci√≥n:', error);
                }
            }, 1000);
        });
        
        // Cargar estado inicial del admin desde Firebase
        function loadInitialAdminState() {
            if (!window.firebase) {
                console.log('Firebase no disponible para cargar estado inicial del admin');
                return;
            }
            
            const { database, ref, get } = window.firebase;
            
            // Cargar estado del juego
            get(ref(database, 'gameState')).then((snapshot) => {
                const gameState = snapshot.val();
                if (gameState) {
                    gameActive = gameState.gameActive || false;
                    currentRound = gameState.currentRound || 1;
                    selectedBingoIndex = gameState.selectedBingoIndex || -1;
                    currentPattern = gameState.currentPattern;
                    
                    console.log('‚úÖ Estado inicial del admin cargado:', gameState);
                    
                    // Actualizar botones seg√∫n el estado
                    if (gameActive || gameState.isPaused) {
                        document.getElementById('start-round').style.display = 'none';
                        document.getElementById('pause-round').style.display = 'inline-block';
                        
                        if (gameState.isPaused) {
                            document.getElementById('pause-round').textContent = '‚ñ∂Ô∏è Reanudar';
                        } else {
                            document.getElementById('pause-round').textContent = '‚è∏Ô∏è Pausar';
                        }
                    } else {
                        document.getElementById('start-round').style.display = 'inline-block';
                        document.getElementById('pause-round').style.display = 'none';
                    }
                    
                    updateStats();
                    renderSchedule();
                }
            });
            
            // Cargar n√∫meros cantados
            get(ref(database, 'calledNumbers')).then((snapshot) => {
                const numbers = snapshot.val();
                if (numbers && Array.isArray(numbers)) {
                    calledNumbers = [...numbers];
                    console.log('‚úÖ N√∫meros cantados cargados en admin:', numbers.length);
                }
            });
        }
        
        // Funciones faltantes para compatibilidad
        function addNewSchedule() {
            const time = prompt('Hora del nuevo bingo (HH:MM):');
            if (time && time.match(/^\d{2}:\d{2}$/)) {
                dailySchedule.push({
                    label: time,
                    time: time,
                    completed: false
                });
                dailySchedule.sort((a, b) => a.time.localeCompare(b.time));
                showPopup('Horario Agregado', `Bingo agregado a las ${time}`);
                renderSchedule();
            } else {
                showPopup('Error', 'Formato inv√°lido. Usa HH:MM');
            }
        }
        
        function renderSchedule() {
            // Actualizar selector de bingos con horarios diarios
            updateBingoSelector();
            renderWeeklyCalendar();
        }
        
        function editSpecialBingo(bingoId) {
            const bingo = specialBingos.find(b => b.id === bingoId);
            if (!bingo) return;
            
            const newName = prompt('Nombre:', bingo.name);
            const newPrice = prompt('Precio:', bingo.price);
            
            if (newName) bingo.name = newName;
            if (newPrice) bingo.price = parseInt(newPrice);
            
            saveSpecialBingos();
            renderSpecialBingos();
            updateBingoSelector();
        }
        
        function deleteSpecialBingo(bingoId) {
            if (!confirm('¬øEliminar bingo especial?')) return;
            
            const index = specialBingos.findIndex(b => b.id === bingoId);
            if (index !== -1) {
                specialBingos.splice(index, 1);
                saveSpecialBingos();
                renderSpecialBingos();
                updateBingoSelector();
            }
        }
        
        // SISTEMA DE VERIFICACI√ìN DE CARTONES
        function initializeVerificationSystem() {
            // Event listeners para verificaci√≥n
            document.getElementById('verify-winner').addEventListener('click', verifyWinner);
            document.getElementById('reject-winner').addEventListener('click', rejectWinner);
            
            // Cargar datos iniciales
            loadWinners();
            updatePrizeStats();
            showPrizeTab('pending');
        }
        
        function checkPendingBingo() {
            if (!window.firebase) return;
            
            const { database, ref, onValue } = window.firebase;
            onValue(ref(database, 'pendingBingoVerification'), (snapshot) => {
                const pendingBingo = snapshot.val();
                if (pendingBingo) {
                    showBingoPending(pendingBingo);
                } else {
                    showNoBingo();
                }
            });
        }
        
        function showBingoPending(bingoData) {
            document.getElementById('no-bingo-pending').style.display = 'none';
            document.getElementById('bingo-pending').style.display = 'block';
            
            document.getElementById('winner-carton').textContent = bingoData.cartonId || 'C123';
            document.getElementById('winner-phone').textContent = bingoData.phone || '0414-1234567';
            document.getElementById('winner-type').textContent = bingoData.type || 'Patr√≥n';
            
            console.log('Mostrando BINGO pendiente en panel admin:', bingoData);
        }
        
        function showNoBingo() {
            document.getElementById('no-bingo-pending').style.display = 'block';
            document.getElementById('bingo-pending').style.display = 'none';
        }
        
        async function verifyWinner() {
            if (!window.firebase) return;
            
            const { database, ref, get, set } = window.firebase;
            const snapshot = await get(ref(database, 'pendingBingoVerification'));
            const bingoData = snapshot.val();
            
            if (!bingoData) {
                console.log('No hay BINGO pendiente para verificar');
                return;
            }
            console.log('Verificando ganador:', bingoData);
            
            // Determinar si es l√≠nea o cart√≥n lleno
            const isLine = bingoData.type === 'LINEA';
            const isBingo = bingoData.type === 'CARTON_LLENO';
            
            // Crear registro del ganador
            const winner = {
                id: Date.now(),
                cartonId: bingoData.cartonId || 'C123',
                phone: bingoData.phone || '0414-1234567',
                type: bingoData.typeText || (isLine ? 'L√≠nea' : 'Cart√≥n Lleno'),
                amount: await calculatePrizeAmount(),
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('es-VE', { hour12: false }),
                round: bingoData.round || currentRound,
                bingoTime: bingoData.timestamp || new Date().toISOString()
            };
            
            // Guardar ganador
            if (window.firebase) {
                saveWinnerToFirebase(winner);
            }
            
            bingoWinners.unshift(winner);
            if (bingoWinners.length > 50) bingoWinners = bingoWinners.slice(0, 50);
            
            // Crear premio pendiente con informaci√≥n completa
            const prize = {
                id: Date.now() + 1,
                cartonId: winner.cartonId,
                phone: winner.phone,
                userName: bingoData.userName || `Usuario ${winner.phone.slice(-4)}`,
                type: winner.type,
                amount: winner.amount,
                date: winner.date,
                time: winner.time,
                status: 'pending',
                winnerId: winner.id,
                round: currentRound,
                gameId: bingoData.gameId || Date.now()
            };
            
            if (window.firebase) {
                savePrizeToFirebase(prize);
            }
            
            bingoPrizes.unshift(prize);
            
            // Crear resultado de verificaci√≥n para el jugador
            const verificationResult = {
                isCorrect: true,
                isWinner: bingoData.phone === bingoData.phone,
                winnerCard: winner.cartonId,
                type: winner.type,
                typeText: winner.type,
                prize: winner.amount,
                gameEnded: isBingo || currentRound === 2
            };
            
            await set(ref(database, 'bingoVerificationResult'), verificationResult);
            
            // Limpiar verificaci√≥n pendiente en Firebase
            await set(ref(database, 'pendingBingoVerification'), null);
            await set(ref(database, 'globalBingoAlert'), null);
            
            // Actualizar estado del juego
            const gameStateSnapshot = await get(ref(database, 'gameState'));
            const gameState = gameStateSnapshot.val() || {};
            
            if (isLine && currentRound === 1) {
                // L√≠nea en ronda 1 - continuar a ronda 2
                currentRound = 2;
                gameState.currentRound = 2;
                gameState.gameActive = true;
                gameState.isPaused = false;
                showPopup('L√≠nea Verificada', `¬°L√≠nea verificada! Premio: BsF ${winner.amount}. Iniciando Ronda 2...`);
            } else {
                // Cart√≥n lleno o l√≠nea en ronda 2 - terminar juego
                gameActive = false;
                currentRound = 1;
                gameState.gameActive = false;
                gameState.currentRound = 1;
                gameState.isPaused = false;
                
                stopAutomaticCalling();
                if (selectedBingoIndex !== -1) {
                    dailySchedule[selectedBingoIndex].completed = true;
                }
                selectedBingoIndex = -1;
                
                expireAllActiveCards();
                resetPrizesAfterCompleteGame();
                
                showPopup('BINGO Verificado', `¬°${winner.type} verificado! Premio: BsF ${winner.amount}. Juego terminado.`);
            }
            
            await set(ref(database, 'gameState'), gameState);
            
            // Actualizar displays
            loadWinners();
            updatePrizeStats();
            showPrizeTab(currentPrizeTab);
            renderSchedule();
            updateStats();
        }
        
        async function rejectWinner() {
            if (!window.firebase) return;
            
            const { database, ref, get, set } = window.firebase;
            console.log('Rechazando BINGO');
            
            // Crear resultado de verificaci√≥n negativo
            const verificationResult = {
                isCorrect: false,
                isWinner: false,
                message: 'BINGO incorrecto'
            };
            
            await set(ref(database, 'bingoVerificationResult'), verificationResult);
            
            // Limpiar verificaci√≥n pendiente en Firebase
            await set(ref(database, 'pendingBingoVerification'), null);
            await set(ref(database, 'globalBingoAlert'), null);
            
            // Reanudar juego
            const gameStateSnapshot = await get(ref(database, 'gameState'));
            const gameState = gameStateSnapshot.val() || {};
            gameState.isPaused = false;
            delete gameState.pauseReason;
            delete gameState.pauseTimestamp;
            await set(ref(database, 'gameState'), gameState);
            
            showPopup('BINGO Rechazado', 'El BINGO fue rechazado. El juego contin√∫a.');
        }
        
        async function calculatePrizeAmount() {
            // Calcular desde allPayments (ya cargado desde Firebase)
            const verifiedPurchases = allPayments.filter(p => p.status === 'verified');
            const totalRecaudado = verifiedPurchases.reduce((sum, p) => sum + p.cartones, 0) * 60;
            const totalParaPremios = totalRecaudado * 0.75;
            const roundPrize = currentRound === 1 ? totalParaPremios * 0.25 : totalParaPremios * 0.75;
            
            // Verificar si hay m√∫ltiples ganadores en esta ronda
            const { database, ref, get } = window.firebase;
            const winnersSnapshot = await get(ref(database, 'winners'));
            const allWinners = winnersSnapshot.val() ? Object.values(winnersSnapshot.val()) : [];
            
            // Contar ganadores de la ronda actual del juego actual
            const currentGameWinners = allWinners.filter(w => 
                w.round === currentRound && 
                w.date === new Date().toISOString().split('T')[0]
            );
            
            const winnersCount = currentGameWinners.length + 1; // +1 por el ganador actual
            const dividedPrize = roundPrize / winnersCount;
            
            return Math.round(dividedPrize * 100) / 100;
        }
        
        // GESTI√ìN DE PREMIOS
        function updatePrizeStats() {
            const pendingPrizes = bingoPrizes.filter(p => p.status === 'pending');
            const paidPrizes = bingoPrizes.filter(p => p.status === 'paid');
            const totalPending = pendingPrizes.reduce((sum, p) => sum + p.amount, 0);
            
            document.getElementById('pending-prizes').textContent = pendingPrizes.length;
            document.getElementById('paid-prizes').textContent = paidPrizes.length;
            document.getElementById('total-pending').textContent = `BsF ${totalPending.toFixed(2)}`;
        }
        
        function showPrizeTab(tab) {
            currentPrizeTab = tab;
            
            // Actualizar botones
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event?.target?.classList.add('active') || document.querySelector(`[onclick="showPrizeTab('${tab}')"]`).classList.add('active');
            
            // Mostrar contenido
            const container = document.getElementById('prizes-content');
            const prizes = bingoPrizes.filter(p => p.status === tab);
            
            if (prizes.length === 0) {
                container.innerHTML = `<p style="text-align:center; color:#666; padding:1rem;">No hay premios ${tab === 'pending' ? 'pendientes' : 'pagados'}</p>`;
                return;
            }
            
            container.innerHTML = prizes.map(prize => `
                <div class="prize-item ${prize.status}">
                    <div class="prize-header">
                        <div>
                            <strong>Cart√≥n: ${prize.cartonId}</strong>
                            <div class="prize-info">${prize.userName || 'Usuario'} ‚Ä¢ ${prize.phone}</div>
                            <div class="prize-info">${prize.type} ‚Ä¢ Ronda ${prize.round || 1}</div>
                        </div>
                        <div class="prize-amount">BsF ${prize.amount}</div>
                    </div>
                    <div class="prize-info">
                        ${prize.date} ${prize.time}
                    </div>
                    <div class="prize-actions">
                        ${prize.status === 'pending' ? 
                            `<button class="pay-btn" onclick="markAsPaid(${prize.id})">Marcar Pagado</button>` :
                            `<span class="paid-badge">‚úì Pagado</span>`
                        }
                    </div>
                </div>
            `).join('');
        }
        
        function markAsPaid(prizeId) {
            const prize = bingoPrizes.find(p => p.id === prizeId);
            if (prize) {
                prize.status = 'paid';
                prize.paidDate = new Date().toISOString().split('T')[0];
                prize.paidTime = new Date().toLocaleTimeString('es-VE', { hour12: false });
                
                if (window.firebase) {
                    savePrizeToFirebase(prize);
                }
                
                localStorage.setItem('bingoPrizes', JSON.stringify(bingoPrizes));
                
                showPopup('Premio Pagado', `Premio de BsF ${prize.amount} marcado como pagado`);
                updatePrizeStats();
                showPrizeTab(currentPrizeTab);
            }
        }
        
        // HISTORIAL DE GANADORES
        function loadWinners() {
            filteredWinners = [...bingoWinners];
            renderWinnersList();
        }
        
        function filterWinners() {
            const dateFilter = document.getElementById('winner-date-filter').value;
            const phoneFilter = document.getElementById('winner-phone-filter').value;
            
            filteredWinners = bingoWinners.filter(winner => {
                const matchDate = !dateFilter || winner.date === dateFilter;
                const matchPhone = !phoneFilter || winner.phone.includes(phoneFilter);
                return matchDate && matchPhone;
            });
            
            renderWinnersList();
        }
        
        function renderWinnersList() {
            const container = document.getElementById('winners-list');
            
            if (filteredWinners.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666; padding:0.5rem;">No hay ganadores registrados</p>';
                return;
            }
            
            container.innerHTML = filteredWinners.slice(0, 10).map(winner => `
                <div class="winner-item">
                    <div class="winner-header">
                        <span>Cart√≥n: ${winner.cartonId}</span>
                        <span>BsF ${winner.amount}</span>
                    </div>
                    <div class="winner-details">
                        ${winner.phone} ‚Ä¢ ${winner.type} ‚Ä¢ ${winner.date} ${winner.time}
                    </div>
                </div>
            `).join('');
        }
        
        // Cargar compras desde Firebase √∫nicamente
        function loadPendingPurchases() {
            if (!window.firebase) {
                console.error('‚ùå Firebase no disponible - no se pueden cargar compras');
                allPayments = [];
                updatePaymentStats();
                return;
            }
            
            loadPurchasesFromFirebase();
        }

        // Controles de rondas
        document.getElementById('start-round').addEventListener('click', () => {
            if (selectedBingoIndex === -1) {
                showPopup('Error', 'Selecciona un horario de bingo primero');
                return;
            }
            gameActive = true;
            const selectedBingo = dailySchedule[selectedBingoIndex];
            
            // Mostrar bot√≥n pausar y ocultar iniciar
            document.getElementById('start-round').style.display = 'none';
            document.getElementById('pause-round').style.display = 'inline-block';
            
            // Guardar estado antes de iniciar
            saveGameState();
            
            // Iniciar cantado autom√°tico SOLO cuando el admin presiona el bot√≥n
            startAutomaticCalling();
            
            showPopup('Ronda Iniciada', `Iniciando ronda ${currentRound} del bingo de las ${selectedBingo.label}`);
            updateStats();
        });

        document.getElementById('pause-round').addEventListener('click', () => {
            if (gameActive) {
                // Pausar juego
                gameActive = false;
                stopAutomaticCalling();
                
                // Actualizar estado del juego
                const gameState = JSON.parse(localStorage.getItem('bingoGameState') || '{}');
                gameState.isPaused = true;
                gameState.pauseReason = 'admin_pause';
                gameState.pauseTimestamp = Date.now();
                localStorage.setItem('bingoGameState', JSON.stringify(gameState));
                
                // Pausar tambi√©n en Firebase
                pauseGameInFirebase('admin_pause');
                
                // Cambiar botones
                document.getElementById('pause-round').textContent = 'Reanudar Ronda';
                
                showPopup('Ronda Pausada', 'La ronda ha sido pausada por el administrador');
            } else {
                // Reanudar juego
                gameActive = true;
                
                // Actualizar estado del juego
                const gameState = JSON.parse(localStorage.getItem('bingoGameState') || '{}');
                gameState.gameActive = true;
                gameState.isPaused = false;
                delete gameState.pauseReason;
                delete gameState.pauseTimestamp;
                localStorage.setItem('bingoGameState', JSON.stringify(gameState));
                
                // Reanudar tambi√©n en Firebase
                saveGameStateToFirebase();
                
                // Reiniciar cantado autom√°tico SOLO si el admin reanuda manualmente
                startAutomaticCalling();
                
                // Cambiar botones
                document.getElementById('pause-round').textContent = 'Pausar Ronda';
                
                showPopup('Ronda Reanudada', 'La ronda ha sido reanudada');
            }
        });

        // Event listener para bingo instant√°neo
        document.getElementById('start-instant-bingo').addEventListener('click', () => {
            if (gameActive) {
                showPopup('Error', 'Ya hay un bingo en curso');
                return;
            }
            
            // Configurar bingo instant√°neo
            selectedBingoIndex = -1; // No programado
            selectedBingoId = 'instant-' + Date.now();
            gameActive = true;
            currentRound = 1;
            calledNumbers = [];
            
            // Mostrar botones correctos
            document.getElementById('start-round').style.display = 'none';
            document.getElementById('pause-round').style.display = 'inline-block';
            
            // Guardar estado
            saveGameState();
            
            // Iniciar cantado autom√°tico
            startAutomaticCalling();
            
            showPopup('Bingo Instant√°neo', '‚ö° Bingo instant√°neo iniciado!');
            updateStats();
        });
        
        // Agregar event listeners para botones cr√≠ticos
        document.getElementById('cancel-bingo').addEventListener('click', () => {
            if (!confirm('¬øCancelar el bingo actual? Esta acci√≥n no se puede deshacer.')) return;
            
            gameActive = false;
            currentRound = 1;
            selectedBingoIndex = -1;
            calledNumbers = [];
            
            stopAutomaticCalling();
            
            // Restaurar botones
            document.getElementById('start-round').style.display = 'inline-block';
            document.getElementById('pause-round').style.display = 'none';
            
            // Limpiar Firebase
            if (window.firebase) {
                const { database, ref, set } = window.firebase;
                set(ref(database, 'gameState'), null);
                set(ref(database, 'calledNumbers'), null);
            }
            
            // Limpiar localStorage
            localStorage.removeItem('bingoGameState');
            
            // Marcar cartones como vencidos
            expireAllCardsInFirebase();
            
            showPopup('Bingo Cancelado', 'El bingo ha sido cancelado');
            updateStats();
        });
        
        document.getElementById('reset-system').addEventListener('click', () => {
            if (!confirm('‚ö†Ô∏è RESET TOTAL DEL SISTEMA\n\n¬øEst√°s seguro? Esto eliminar√°:\n‚Ä¢ Todos los premios y ganadores\n‚Ä¢ Todos los pagos y compras\n‚Ä¢ Todos los cartones\n‚Ä¢ Estado del juego\n‚Ä¢ Historial completo\n\nEsta acci√≥n NO se puede deshacer.')) {
                return;
            }
            
            // RESET TOTAL DEL SISTEMA
            dailyPrizeTotal = 0;
            ticketsSoldToday = 0;
            selectedBingoIndex = -1;
            currentRound = 1;
            gameActive = false;
            calledNumbers = [];
            bingoWinners = [];
            bingoPrizes = [];
            allPayments = [];
            filteredPayments = [];
            filteredWinners = [];
            
            // Horarios
            dailySchedule.forEach(bingo => bingo.completed = false);
            
            // Detener juego
            stopAutomaticCalling();
            
            // LIMPIAR TODO EL LOCALSTORAGE
            localStorage.removeItem('bingoGameState');
            localStorage.removeItem('pendingBingoVerification');
            localStorage.removeItem('globalBingoAlert');
            localStorage.removeItem('bingoWinners');
            localStorage.removeItem('bingoPrizes');
            localStorage.removeItem('playerCards');
            localStorage.removeItem('pendingPurchases');
            localStorage.removeItem('verifiedPurchases');
            localStorage.removeItem('rejectedPurchases');
            localStorage.removeItem('userPhone');
            localStorage.removeItem('userProfile');
            
            // Actualizar displays
            loadPendingPurchases();
            loadWinners();
            updatePrizeStats();
            showPrizeTab('pending');
            initializeNewSystem();
            updateStats();
            
            showPopup('üîÑ RESET TOTAL COMPLETADO', 'Sistema completamente reiniciado. Todos los datos han sido eliminados.');
        });

        document.getElementById('end-round').addEventListener('click', () => {
            gameActive = false;
            
            // Detener cantado autom√°tico
            stopAutomaticCalling();
            
            // Restaurar botones
            document.getElementById('start-round').style.display = 'inline-block';
            document.getElementById('pause-round').style.display = 'none';
            document.getElementById('pause-round').textContent = 'Pausar Ronda';
            
            if (currentRound === 2) {
                // Juego completado - marcar cartones como vencidos
                currentRound = 1;
                selectedBingoIndex = -1;
                calledNumbers = [];
                
                // Marcar cartones como vencidos en Firebase
                expireAllCardsInFirebase();
                
                // Limpiar Firebase
                if (window.firebase) {
                    const { database, ref, set } = window.firebase;
                    set(ref(database, 'gameState'), {
                        gameActive: false,
                        gameFinalized: true,
                        bothRoundsCompleted: true,
                        timestamp: Date.now()
                    });
                    set(ref(database, 'calledNumbers'), null);
                }
                
                showPopup('Bingo Completado', 'Las 2 rondas han terminado. Todos los cartones han expirado.');
            } else {
                // Avanzar a ronda 2
                currentRound = 2;
                calledNumbers = [];
                
                if (window.firebase) {
                    const { database, ref, set } = window.firebase;
                    set(ref(database, 'gameState'), {
                        gameActive: false,
                        currentRound: 2,
                        timestamp: Date.now()
                    });
                    set(ref(database, 'calledNumbers'), []);
                }
                
                showPopup('Ronda Finalizada', 'Ronda 1 completada. Preparando ronda 2...');
            }
            
            // Limpiar localStorage
            localStorage.removeItem('bingoGameState');
            
            updateStats();
        });

        // Funci√≥n reset-prizes removida (duplicada con reset-system)

        // Actualizar estad√≠sticas de pagos
        function updatePaymentStats() {
            const pending = allPayments.filter(p => p.status === 'pending').length;
            const verified = allPayments.filter(p => p.status === 'verified').length;
            const rejected = allPayments.filter(p => p.status === 'rejected').length;
            
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('verified-count').textContent = verified;
            document.getElementById('rejected-count').textContent = rejected;
        }

        // Mostrar pagos por categor√≠a
        function showPayments(status) {
            currentFilter = status;
            const titles = {
                'pending': 'Pagos Pendientes',
                'verified': 'Pagos Verificados', 
                'rejected': 'Pagos Rechazados'
            };
            
            document.getElementById('modal-title').textContent = titles[status];
            document.getElementById('payment-modal').style.display = 'flex';
            
            filterPayments();
            
            // Actualizar lista cada 2 segundos mientras el modal est√© abierto
            if (window.paymentModalInterval) {
                clearInterval(window.paymentModalInterval);
            }
            window.paymentModalInterval = setInterval(() => {
                if (document.getElementById('payment-modal').style.display === 'flex') {
                    loadPendingPurchases();
                    filterPayments();
                } else {
                    clearInterval(window.paymentModalInterval);
                }
            }, 2000);
        }

        // Cerrar modal
        function closePaymentModal() {
            document.getElementById('payment-modal').style.display = 'none';
            document.getElementById('date-filter').value = '';
            document.getElementById('phone-filter').value = '';
            
            // Limpiar intervalo de actualizaci√≥n del modal
            if (window.paymentModalInterval) {
                clearInterval(window.paymentModalInterval);
                window.paymentModalInterval = null;
            }
        }

        // Filtrar pagos
        function filterPayments() {
            const dateFilter = document.getElementById('date-filter').value;
            const phoneFilter = document.getElementById('phone-filter').value;
            
            filteredPayments = allPayments.filter(payment => {
                const matchStatus = payment.status === currentFilter;
                const matchDate = !dateFilter || payment.date === dateFilter;
                const matchPhone = !phoneFilter || payment.phone.includes(phoneFilter);
                
                return matchStatus && matchDate && matchPhone;
            });
            
            renderPaymentsList();
        }

        // Renderizar lista de pagos
        function renderPaymentsList() {
            const container = document.getElementById('payments-list');
            container.innerHTML = '';
            
            if (filteredPayments.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666;">No se encontraron pagos</p>';
                return;
            }
            
            filteredPayments.forEach(payment => {
                const item = document.createElement('div');
                item.className = 'payment-item';
                
                let actions = '';
                if (payment.status === 'pending') {
                    actions = `
                        <div class="payment-actions">
                            <button class="payment-btn approve-btn" onclick="approvePayment(${payment.id})">‚úì</button>
                            <button class="payment-btn reject-btn" onclick="rejectPayment(${payment.id})">‚úó</button>
                        </div>
                    `;
                } else if (payment.status === 'verified') {
                    actions = `
                        <div class="payment-actions">
                            <button class="payment-btn reject-btn" onclick="rejectVerifiedPayment(${payment.id})">‚úó Rechazar</button>
                        </div>
                    `;
                }
                
                item.innerHTML = `
                    <div>
                        <strong>Ref: ${payment.ref}</strong> - <strong>${payment.phone}</strong><br>
                        <small>${payment.cartones} cartones - BsF ${payment.amount} - ${payment.date}</small>
                    </div>
                    ${actions}
                `;
                container.appendChild(item);
            });
        }

        // Aprobar pago
        function approvePayment(paymentId) {
            const payment = allPayments.find(p => p.id === paymentId);
            if (!payment) return;
            
            if (!window.firebase) {
                alert('‚ùå Firebase no disponible - no se puede aprobar el pago');
                return;
            }
            
            payment.status = 'verified';
            payment.verifiedDate = new Date().toISOString();
            
            updatePurchaseInFirebase(payment);
            
            ticketsSoldToday += payment.cartones;
            dailyPrizeTotal += payment.amount * 0.75;
            
            // Generar cartones para el jugador
            generateCardsForPlayer(payment.phone, payment.cartones);
            
            showPopup('Pago Aprobado', `Se han asignado ${payment.cartones} cartones al tel√©fono ${payment.phone}`);
            loadPendingPurchases();
            filterPayments();
            updateStats();
        }

        // Rechazar pago
        function rejectPayment(paymentId) {
            const payment = allPayments.find(p => p.id === paymentId);
            if (!payment) return;
            
            if (!window.firebase) {
                alert('‚ùå Firebase no disponible - no se puede rechazar el pago');
                return;
            }
            
            payment.status = 'rejected';
            payment.rejectedDate = new Date().toISOString();
            
            updatePurchaseInFirebase(payment);
            
            showPopup('Pago Rechazado', `Pago del tel√©fono ${payment.phone} ha sido rechazado.`);
            loadPendingPurchases();
            filterPayments();
        }

        // Rechazar pago verificado
        function rejectVerifiedPayment(paymentId) {
            const payment = allPayments.find(p => p.id === paymentId);
            if (payment) {
                payment.status = 'rejected';
                ticketsSoldToday -= payment.cartones;
                dailyPrizeTotal -= payment.amount * 0.75; // Restar 75% de premios
                
                showPopup('Pago Corregido', `Pago verificado del tel√©fono ${payment.phone} ha sido rechazado. Cartones retirados.`);
                updatePaymentStats();
                filterPayments();
                updateStats();
            }
        }

        // Actualizar estad√≠sticas
        function updateStats() {
            document.getElementById('current-round').textContent = `${currentRound} de 2`;
            document.getElementById('tickets-sold').textContent = ticketsSoldToday;
            
            const totalRecaudado = ticketsSoldToday * 60;
            const totalParaPremios = totalRecaudado * 0.75; // Descontar 25% del due√±o
            const roundPrize = currentRound === 1 ? totalParaPremios * 0.25 : totalParaPremios * 0.75;
            document.getElementById('round-prize').textContent = `BsF ${roundPrize.toFixed(2)}`;
            document.getElementById('daily-total').textContent = `BsF ${dailyPrizeTotal.toFixed(2)}`;
            
            // Actualizar estado del juego si est√° activo
            if (gameActive) {
                saveGameState();
            }
        }

        // INICIALIZAR NUEVO SISTEMA
        function initializeNewSystem() {
            try {
                if (window.firebase) {
                    loadWeeklySchedule();
                    loadSpecialBingos();
                    loadNotificationHistory();
                }
                loadDomainConfig();
                renderWeeklyCalendar();
                renderSpecialBingos();
                updateBingoSelector();
                setupEventListeners();
            } catch (error) {
                console.error('Error inicializando sistema:', error);
            }
        }
        
        // RENDERIZAR CALENDARIO SEMANAL
        function renderWeeklyCalendar() {
            const container = document.getElementById('days-grid');
            container.innerHTML = '';
            
            const days = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
            const dayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            days.forEach((dayName, index) => {
                const dayKey = dayKeys[index];
                const dayBingos = weeklySchedule[dayKey] || [];
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-column';
                
                dayDiv.innerHTML = `
                    <div class="day-header">
                        <h4>${dayName}</h4>
                        <button class="add-bingo-btn" onclick="addBingoToDay('${dayKey}')">‚ûï</button>
                    </div>
                    <div class="day-bingos">
                        ${dayBingos.map(bingo => createBingoCard(bingo, dayKey)).join('')}
                    </div>
                `;
                
                container.appendChild(dayDiv);
            });
        }
        
        function createBingoCard(bingo, dayKey) {
            const statusIcons = {
                programmed: 'üü°',
                active: 'üîµ',
                completed: 'üü¢',
                cancelled: '‚ùå',
                rescheduled: 'üîÑ'
            };
            
            return `
                <div class="bingo-card ${bingo.status}" data-bingo-id="${bingo.id}">
                    <div class="bingo-time">${bingo.time}</div>
                    <div class="bingo-status">${statusIcons[bingo.status]}</div>
                    <div class="bingo-config">BsF ${bingo.price} | x${bingo.multiplier}</div>
                    <div class="bingo-actions">
                        <button onclick="editBingo('${bingo.id}', '${dayKey}')" class="edit-btn">‚úèÔ∏è</button>
                        <button onclick="deleteBingo('${bingo.id}', '${dayKey}')" class="delete-btn">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }

        // GESTI√ìN DE BINGOS
        function addBingoToDay(dayKey) {
            const time = prompt('Hora del bingo (HH:MM):');
            if (!time || !time.match(/^\d{2}:\d{2}$/)) {
                showPopup('Error', 'Formato inv√°lido. Usa HH:MM');
                return;
            }
            
            const template = prompt('Tipo:\n1. Normal (60 BsF)\n2. Premium (100 BsF)\n3. Familiar (40 BsF)\n4. Especial (150 BsF)');
            const templates = ['normal', 'premium', 'familiar', 'especial'];
            const selectedTemplate = templates[parseInt(template) - 1] || 'normal';
            const config = bingoTemplates[selectedTemplate];
            
            const newBingo = {
                id: Date.now().toString(),
                time: time,
                status: 'programmed',
                ...config
            };
            
            if (!weeklySchedule[dayKey]) weeklySchedule[dayKey] = [];
            weeklySchedule[dayKey].push(newBingo);
            weeklySchedule[dayKey].sort((a, b) => a.time.localeCompare(b.time));
            
            saveWeeklySchedule();
            renderWeeklyCalendar();
            updateBingoSelector();
            showPopup('Bingo Agregado', `${selectedTemplate} - ${time}`);
        }
        
        function editBingo(bingoId, dayKey) {
            const bingo = weeklySchedule[dayKey].find(b => b.id === bingoId);
            if (!bingo) return;
            
            const newPrice = prompt('Precio:', bingo.price);
            const newMultiplier = prompt('Multiplicador:', bingo.multiplier);
            
            if (newPrice) bingo.price = parseInt(newPrice);
            if (newMultiplier) bingo.multiplier = parseFloat(newMultiplier);
            
            saveWeeklySchedule();
            renderWeeklyCalendar();
            updateBingoSelector();
        }
        
        function deleteBingo(bingoId, dayKey) {
            if (!confirm('¬øEliminar bingo?')) return;
            
            weeklySchedule[dayKey] = weeklySchedule[dayKey].filter(b => b.id !== bingoId);
            saveWeeklySchedule();
            renderWeeklyCalendar();
            updateBingoSelector();
        }

        // ACTUALIZAR SELECTOR DE BINGOS
        function updateBingoSelector() {
            const selector = document.getElementById('bingo-selector');
            selector.innerHTML = '<option value="">Seleccionar bingo...</option>';
            
            Object.entries(weeklySchedule).forEach(([day, bingos]) => {
                bingos.forEach(bingo => {
                    if (bingo.status === 'programmed') {
                        const dayName = {
                            monday: 'Lun', tuesday: 'Mar', wednesday: 'Mi√©',
                            thursday: 'Jue', friday: 'Vie', saturday: 'S√°b', sunday: 'Dom'
                        }[day];
                        
                        const option = document.createElement('option');
                        option.value = `${day}-${bingo.id}`;
                        option.textContent = `${dayName} ${bingo.time} - BsF ${bingo.price} (x${bingo.multiplier})`;
                        selector.appendChild(option);
                    }
                });
            });
            
            specialBingos.forEach(bingo => {
                if (bingo.status === 'programmed') {
                    const option = document.createElement('option');
                    option.value = `special-${bingo.id}`;
                    option.textContent = `‚ú® ${bingo.name} - ${bingo.date}`;
                    selector.appendChild(option);
                }
            });
        }

        // BINGOS ESPECIALES
        function renderSpecialBingos() {
            const container = document.getElementById('special-list');
            container.innerHTML = specialBingos.map(bingo => `
                <div class="special-bingo ${bingo.status}">
                    <div class="special-info">
                        <strong>${bingo.name}</strong>
                        <div class="special-details">${bingo.date} ${bingo.time} - BsF ${bingo.price}</div>
                    </div>
                    <div class="special-actions">
                        <button onclick="editSpecialBingo('${bingo.id}')">‚úèÔ∏è</button>
                        <button onclick="deleteSpecialBingo('${bingo.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }
        
        function addSpecialBingo() {
            const name = prompt('Nombre:');
            const date = prompt('Fecha (YYYY-MM-DD):');
            const time = prompt('Hora (HH:MM):');
            const price = prompt('Precio:', '150');
            
            if (!name || !date || !time) return;
            
            specialBingos.push({
                id: Date.now().toString(),
                name, date, time,
                price: parseInt(price) || 150,
                multiplier: 2,
                maxCards: 5,
                status: 'programmed'
            });
            
            saveSpecialBingos();
            renderSpecialBingos();
            updateBingoSelector();
        }

        // SISTEMA DE COMUNICACI√ìN
        function setupCommunicationSystem() {
            document.querySelectorAll('.share-whatsapp').forEach(btn => {
                btn.addEventListener('click', function() {
                    const template = this.closest('.message-template');
                    const messageTemplate = template.dataset.messageTemplate;
                    const domain = localStorage.getItem('bingoDomain') || '[DOMINIO NO CONFIGURADO]';
                    const message = messageTemplate.replace('{DOMAIN}', domain);
                    shareToWhatsApp(message);
                });
            });
            
            document.getElementById('share-custom').addEventListener('click', () => {
                const message = document.getElementById('custom-message-text').value;
                if (message.trim()) {
                    shareToWhatsApp(message);
                    document.getElementById('custom-message-text').value = '';
                }
            });
        }
        
        function shareToWhatsApp(message) {
            const encodedMessage = encodeURIComponent(message);
            const url = `https://wa.me/?text=${encodedMessage}`;
            window.open(url, '_blank');
            
            const notification = {
                message: message,
                timestamp: new Date().toISOString(),
                time: new Date().toLocaleTimeString('es-VE')
            };
            
            notificationHistory.unshift(notification);
            if (notificationHistory.length > 20) notificationHistory = notificationHistory.slice(0, 20);
            
            saveNotificationHistory();
            renderNotificationHistory();
            showPopup('Compartido', 'Mensaje enviado a WhatsApp');
        }
        
        function renderNotificationHistory() {
            const container = document.getElementById('notification-log');
            if (notificationHistory.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666;">No hay notificaciones</p>';
                return;
            }
            
            container.innerHTML = notificationHistory.slice(0, 5).map(notif => `
                <div class="notification-item">
                    <div class="notification-time">${notif.time}</div>
                    <div>${notif.message}</div>
                </div>
            `).join('');
        }

        // FUNCIONES DE GUARDADO Y UTILIDADES
        function saveWeeklySchedule() {
            if (!window.firebase) {
                console.error('‚ùå Firebase no disponible - no se puede guardar horario');
                return;
            }
            const { database, ref, set } = window.firebase;
            set(ref(database, 'weeklySchedule'), weeklySchedule)
                .then(() => console.log('‚úÖ Horario guardado en Firebase'))
                .catch(error => console.error('‚ùå Error guardando horario:', error));
        }
        
        function loadWeeklySchedule() {
            if (!window.firebase) {
                console.error('‚ùå Firebase no disponible - no se puede cargar horario');
                return;
            }
            const { database, ref, onValue } = window.firebase;
            onValue(ref(database, 'weeklySchedule'), (snapshot) => {
                const saved = snapshot.val();
                if (saved) {
                    weeklySchedule = saved;
                    renderWeeklyCalendar();
                    updateBingoSelector();
                }
            });
        }
        
        function saveSpecialBingos() {
            if (!window.firebase) {
                console.error('‚ùå Firebase no disponible - no se puede guardar bingos especiales');
                return;
            }
            const { database, ref, set } = window.firebase;
            set(ref(database, 'specialBingos'), specialBingos)
                .then(() => console.log('‚úÖ Bingos especiales guardados en Firebase'))
                .catch(error => console.error('‚ùå Error guardando bingos especiales:', error));
        }
        
        function loadSpecialBingos() {
            if (!window.firebase) {
                console.error('‚ùå Firebase no disponible - no se puede cargar bingos especiales');
                return;
            }
            const { database, ref, onValue } = window.firebase;
            onValue(ref(database, 'specialBingos'), (snapshot) => {
                const saved = snapshot.val();
                if (saved) {
                    specialBingos = saved;
                    renderSpecialBingos();
                    updateBingoSelector();
                }
            });
        }
        
        function saveNotificationHistory() {
            if (!window.firebase) {
                console.error('‚ùå Firebase no disponible - no se puede guardar historial');
                return;
            }
            const { database, ref, set } = window.firebase;
            set(ref(database, 'notificationHistory'), notificationHistory)
                .then(() => console.log('‚úÖ Historial guardado en Firebase'))
                .catch(error => console.error('‚ùå Error guardando historial:', error));
        }
        
        function loadNotificationHistory() {
            if (!window.firebase) {
                console.error('‚ùå Firebase no disponible - no se puede cargar historial');
                return;
            }
            const { database, ref, onValue } = window.firebase;
            onValue(ref(database, 'notificationHistory'), (snapshot) => {
                const saved = snapshot.val();
                if (saved) {
                    notificationHistory = saved;
                    renderNotificationHistory();
                }
            });
        }
        
        function updateWeekDisplay() {
            const start = new Date(currentWeekStart);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            
            const options = { day: 'numeric', month: 'short' };
            const startStr = start.toLocaleDateString('es-ES', options);
            const endStr = end.toLocaleDateString('es-ES', options);
            
            document.getElementById('week-display').textContent = `${startStr} - ${endStr}`;
        }
        
        function setupEventListeners() {
            // Selector de bingo
            document.getElementById('bingo-selector').addEventListener('change', function() {
                selectedBingoId = this.value;
                document.getElementById('start-round').disabled = !selectedBingoId;
            });
            
            // Navegaci√≥n de semanas
            document.getElementById('prev-week').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                updateWeekDisplay();
            });
            
            document.getElementById('next-week').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                updateWeekDisplay();
            });
            
            // Bingos especiales
            document.getElementById('add-special').addEventListener('click', addSpecialBingo);
            
            // Configuraci√≥n de dominio
            document.getElementById('save-domain').addEventListener('click', saveDomainConfig);
            
            // Sistema de comunicaci√≥n
            setupCommunicationSystem();
        }
        
        function startGameTimer() {
            if (gameTimer) clearInterval(gameTimer);
            
            gameTimer = setInterval(() => {
                if (gameActive && gameStartTime) {
                    const elapsed = Date.now() - gameStartTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    
                    document.getElementById('game-time').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    document.getElementById('numbers-count').textContent = `${calledNumbers.length}/75`;
                    document.getElementById('round-display').textContent = `${currentRound}/2`;
                    
                    // Mostrar panel de control si hay juego activo
                    const display = document.getElementById('current-bingo-display');
                    if (gameActive) {
                        display.style.display = 'block';
                        
                        const status = document.getElementById('bingo-status');
                        if (gameActive) {
                            status.textContent = 'üîµ EN CURSO';
                            status.style.background = 'rgba(0,123,255,0.2)';
                        }
                    } else {
                        display.style.display = 'none';
                    }
                }
            }, 1000);
        }

        // Funciones para controlar el juego
        function saveGameState() {
            const currentGameState = localStorage.getItem('bingoGameState');
            let gameStartTime = Date.now();
            
            if (currentGameState) {
                const parsed = JSON.parse(currentGameState);
                gameStartTime = parsed.gameStartTime || Date.now();
            }
            
            const verifiedPurchases = JSON.parse(localStorage.getItem('verifiedPurchases') || '[]');
            const totalRecaudado = verifiedPurchases.reduce((sum, p) => sum + p.cartones, 0) * 60;
            const totalParaPremios = totalRecaudado * 0.75;
            
            const gameState = {
                gameActive: gameActive,
                currentRound: currentRound,
                selectedBingoIndex: selectedBingoIndex,
                roundPrize: currentRound === 1 ? totalParaPremios * 0.25 : totalParaPremios * 0.75,
                calledNumbers: calledNumbers,
                gameStartTime: gameStartTime,
                currentPattern: currentPattern,
                timestamp: Date.now(),
                isPaused: false
            };
            localStorage.setItem('bingoGameState', JSON.stringify(gameState));
            
            // Guardar tambi√©n en Firebase
            saveGameStateToFirebase();
        }

        function startAutomaticCalling() {
            if (!window.firebase) {
                console.error('‚ùå Firebase no disponible - no se puede iniciar cantado');
                return;
            }
            
            // Limpiar n√∫meros para nuevo juego
            calledNumbers = [];
            
            const gameStartTime = Date.now();
            
            // Generar patr√≥n para ronda 1
            if (currentRound === 1) {
                currentPattern = {
                    name: "Patr√≥n Aleatorio",
                    positions: generateRandomPatternPositions()
                };
            } else {
                currentPattern = null;
            }
            
            console.log('üéÆ Iniciando cantado autom√°tico');
            
            // Detener intervalo anterior
            if (callingInterval) {
                clearInterval(callingInterval);
            }
            
            // Actualizar estado inicial en Firebase
            const { database, ref, set } = window.firebase;
            const initialState = {
                gameActive: true,
                currentRound: currentRound,
                calledNumbers: [],
                currentPattern: currentPattern,
                gameStartTime: gameStartTime,
                timestamp: Date.now(),
                adminStarted: true,
                gameId: Date.now()
            };
            
            set(ref(database, 'gameState'), initialState);
            set(ref(database, 'calledNumbers'), []);
            
            // Cantar n√∫meros cada 5 segundos
            callingInterval = setInterval(async () => {
                if (!gameActive) {
                    console.log('‚ùå Juego no activo, deteniendo');
                    stopAutomaticCalling();
                    return;
                }
                
                // Verificar si hay BINGO pendiente
                const pendingSnapshot = await get(ref(database, 'pendingBingoVerification'));
                if (pendingSnapshot.exists()) {
                    console.log('‚è∏Ô∏è BINGO pendiente, pausando cantado');
                    return;
                }
                
                const availableNumbers = [];
                for (let i = 1; i <= 75; i++) {
                    if (!calledNumbers.includes(i)) {
                        availableNumbers.push(i);
                    }
                }
                
                if (availableNumbers.length === 0) {
                    console.log('‚úÖ Todos los n√∫meros cantados');
                    stopAutomaticCalling();
                    return;
                }
                
                const randomNumber = availableNumbers[Math.floor(Math.random() * availableNumbers.length)];
                calledNumbers.push(randomNumber);
                
                console.log('üì¢ Cantando:', randomNumber);
                
                // Cantar n√∫mero con voz
                callNumberWithVoice(randomNumber);
                
                // Actualizar Firebase inmediatamente
                set(ref(database, 'calledNumbers'), calledNumbers);
                set(ref(database, 'gameState'), {
                    gameActive: true,
                    currentRound: currentRound,
                    calledNumbers: calledNumbers,
                    currentPattern: currentPattern,
                    gameStartTime: gameStartTime,
                    timestamp: Date.now(),
                    adminStarted: true,
                    gameId: initialState.gameId
                });
                
            }, 5000);
        }
        
        function generateRandomPatternPositions() {
            const positions = [];
            const patternSize = Math.floor(Math.random() * 5) + 8; // 8-12 casillas
            const maxCells = 12;
            const usedPositions = new Set();
            
            while (positions.length < Math.min(patternSize, maxCells)) {
                const row = Math.floor(Math.random() * 5);
                const col = Math.floor(Math.random() * 5);
                const key = `${row}-${col}`;
                
                if (!usedPositions.has(key)) {
                    positions.push([row, col]);
                    usedPositions.add(key);
                }
            }
            
            return positions;
        }

        function stopAutomaticCalling() {
            console.log('Deteniendo cantado autom√°tico');
            if (callingInterval) {
                clearInterval(callingInterval);
                callingInterval = null;
            }
            // Detener s√≠ntesis de voz
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
        }

        function getBingoLetter(number) {
            if (number >= 1 && number <= 15) return 'B';
            if (number >= 16 && number <= 30) return 'I';
            if (number >= 31 && number <= 45) return 'N';
            if (number >= 46 && number <= 60) return 'G';
            if (number >= 61 && number <= 75) return 'O';
            return '';
        }
        
        // Funci√≥n para cantar n√∫meros con voz
        function callNumberWithVoice(number) {
            if (!('speechSynthesis' in window)) {
                console.log('S√≠ntesis de voz no disponible');
                return;
            }
            
            const letter = getBingoLetter(number);
            const numberCall = `${letter}${number}`;
            
            // Primera llamada
            const utterance1 = new SpeechSynthesisUtterance(numberCall);
            utterance1.lang = 'es-ES';
            utterance1.rate = 0.8;
            utterance1.volume = 1;
            
            // Segunda llamada (repito)
            const utterance2 = new SpeechSynthesisUtterance(`repito ${numberCall}`);
            utterance2.lang = 'es-ES';
            utterance2.rate = 0.8;
            utterance2.volume = 1;
            
            // Cantar primera vez
            speechSynthesis.speak(utterance1);
            
            // Cantar segunda vez despu√©s de pausa
            utterance1.onend = () => {
                setTimeout(() => {
                    speechSynthesis.speak(utterance2);
                }, 300);
            };
        }

        // Actualizar stats cada 10 segundos
        setInterval(updateStats, 10000);
        
        // Cargar todos los usuarios
        function loadAllUsers(showFeedback = false) {
            if (!window.firebase) {
                console.error('‚ùå Firebase no disponible');
                if (showFeedback) showPopup('Error', 'Firebase no disponible');
                return;
            }
            
            const { database, ref, onValue } = window.firebase;
            onValue(ref(database, 'users'), (snapshot) => {
                const users = snapshot.val();
                if (users) {
                    updateUserDropdown(users);
                    updateUserStats(users);
                    if (showFeedback) showPopup('Lista Actualizada', `${Object.keys(users).length} usuarios cargados`);
                } else {
                    // Limpiar dropdown si no hay usuarios
                    const dropdown = document.getElementById('user-dropdown');
                    dropdown.innerHTML = '<option value="">No hay usuarios registrados</option>';
                    if (showFeedback) showPopup('Sin Usuarios', 'No se encontraron usuarios registrados');
                }
            });
        }
        
        function updateUserDropdown(users) {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.innerHTML = '<option value="">Seleccionar jugador...</option>';
            
            Object.entries(users).forEach(([phone, userData]) => {
                const option = document.createElement('option');
                option.value = userData.phone;
                option.textContent = `${userData.phone} - ${userData.name || 'Sin nombre'}`;
                dropdown.appendChild(option);
            });
        }
        
        function updateUserStats(users) {
            const userArray = Object.values(users);
            const totalUsers = userArray.length;
            const activeUsers = userArray.filter(u => !u.blocked && u.lastActivity).length;
            const vipUsers = userArray.filter(u => getUserLevel(u) === 'VIP' || getUserLevel(u) === 'PREMIUM').length;
            
            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('active-users').textContent = activeUsers;
            document.getElementById('vip-users').textContent = vipUsers;
        }
        
        // Buscar usuario
        async function searchUser() {
            const phone = document.getElementById('user-phone-search').value.trim();
            if (!phone) {
                showPopup('Error', 'Ingresa un n√∫mero de tel√©fono');
                return;
            }
            
            if (!window.firebase) {
                showPopup('Error', 'Firebase no disponible');
                return;
            }
            
            const { database, ref, get } = window.firebase;
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            
            try {
                const snapshot = await get(ref(database, `users/${cleanPhone}`));
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    await displayUserProfile(userData);
                } else {
                    showPopup('Usuario no encontrado', 'No se encontraron registros para este tel√©fono');
                    document.getElementById('user-profile').style.display = 'none';
                }
            } catch (error) {
                showPopup('Error', 'Error buscando usuario: ' + error.message);
            }
        }
        
        // Obtener perfil completo del usuario
        async function getUserProfile(phone) {
            if (!window.firebase) return null;
            
            const { database, ref, get } = window.firebase;
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            
            try {
                // Datos del usuario
                const userSnapshot = await get(ref(database, `users/${cleanPhone}`));
                if (!userSnapshot.exists()) return null;
                
                const userData = userSnapshot.val();
                
                // Compras del usuario
                const purchasesSnapshot = await get(ref(database, 'purchases'));
                const allPurchases = purchasesSnapshot.val() ? Object.values(purchasesSnapshot.val()) : [];
                const userPurchases = allPurchases.filter(p => p.phone === phone);
                
                // Cartones del usuario
                const cardsSnapshot = await get(ref(database, `playerCards/${cleanPhone}`));
                const userCards = cardsSnapshot.val() || [];
                
                // Premios del usuario
                const winnersSnapshot = await get(ref(database, 'winners'));
                const allWinners = winnersSnapshot.val() ? Object.values(winnersSnapshot.val()) : [];
                const userWinners = allWinners.filter(w => w.phone === phone);
                
                const verifiedPurchases = userPurchases.filter(p => p.status === 'verified');
                const totalSpent = verifiedPurchases.reduce((sum, p) => sum + (p.amount || 0), 0);
                const totalCards = verifiedPurchases.reduce((sum, p) => sum + (p.cartones || 0), 0);
                const totalPrizes = userWinners.reduce((sum, w) => sum + (w.amount || 0), 0);
                
                const vigentCards = Array.isArray(userCards) ? userCards.filter(c => c.status === 'vigente').length : 0;
                const enUsoCards = Array.isArray(userCards) ? userCards.filter(c => c.status === 'en_uso').length : 0;
                const vencidoCards = Array.isArray(userCards) ? userCards.filter(c => c.status === 'vencido').length : 0;
                
                return {
                    ...userData,
                    totalPurchases: userPurchases.length || 0,
                    totalSpent: totalSpent || 0,
                    totalCards: totalCards || 0,
                    totalPrizes: totalPrizes || 0,
                    vigentCards: vigentCards || 0,
                    enUsoCards: enUsoCards || 0,
                    vencidoCards: vencidoCards || 0,
                    bingosWon: userWinners.length || 0,
                    purchases: userPurchases.sort((a, b) => new Date(b.date) - new Date(a.date)) || [],
                    winners: userWinners.sort((a, b) => (b.id || 0) - (a.id || 0)) || [],
                    lastActivity: userPurchases.length > 0 ? userPurchases[userPurchases.length - 1].date : (userData.createdDate || 'N/A')
                };
            } catch (error) {
                console.error('Error obteniendo perfil:', error);
                return null;
            }
        }
        
        // Simular cartones del usuario
        function getUserCards(phone) {
            // En producci√≥n esto vendr√≠a de una base de datos
            // Por ahora simulamos algunos cartones
            return [
                { id: 'A1B2C', status: 'vigente', purchaseDate: '2024-01-15' },
                { id: 'D3E4F', status: 'vigente', purchaseDate: '2024-01-15' },
                { id: 'G5H6I', status: 'vencido', purchaseDate: '2024-01-14' },
                { id: 'J7K8L', status: 'vencido', purchaseDate: '2024-01-14' }
            ];
        }
        
        // Mostrar perfil completo del usuario
        async function displayUserProfile(profile) {
            const container = document.getElementById('user-profile');
            container.style.display = 'block';
            
            const userLevel = getUserLevel(profile);
            const levelClass = userLevel.toLowerCase().replace(' ', '-');
            
            container.innerHTML = `
                <div class="user-header">
                    <h4 style="margin: 0; color: var(--accent-color); display: inline-block;">
                        üë§ ${profile.name || 'Usuario'}
                        <span class="user-level ${levelClass}">${userLevel}</span>
                    </h4>
                    <p style="margin: 0.2rem 0; color: #666; font-size: 0.9rem;">
                        üìû ${profile.phone} | üìÖ Registro: ${new Date(profile.createdDate).toLocaleDateString('es-ES')}
                        ${profile.blocked ? ' | üö´ BLOQUEADO' : ''}
                    </p>
                </div>
                
                <div class="user-actions">
                    <button class="user-action-btn edit" onclick="editUser('${profile.phone}')">‚úèÔ∏è Editar</button>
                    <button class="user-action-btn reset-pin" onclick="resetUserPIN('${profile.phone}')">üîê Reset PIN</button>
                    <button class="user-action-btn ${profile.blocked ? 'unblock' : 'block'}" onclick="${profile.blocked ? 'unblockUser' : 'blockUser'}('${profile.phone}')">
                        ${profile.blocked ? '‚úÖ Desbloquear' : 'üö´ Bloquear'}
                    </button>
                    <button class="user-action-btn gift" onclick="giftCards('${profile.phone}')">üéÅ Regalar</button>
                    <button class="user-action-btn delete" onclick="deleteUser('${profile.phone}')">üóëÔ∏è Eliminar</button>
                    <button class="user-action-btn edit" onclick="exportUserData('${profile.phone}')">üì§ Exportar</button>
                </div>
                
                <div class="user-cards-grid">
                    <div class="user-stat">
                        <span class="user-stat-number">${profile.totalCards || 0}</span>
                        <span class="user-stat-label">Cartones Comprados</span>
                    </div>
                    <div class="user-stat">
                        <span class="user-stat-number">${profile.vigentCards || 0}</span>
                        <span class="user-stat-label">Vigentes</span>
                    </div>
                    <div class="user-stat">
                        <span class="user-stat-number">${profile.enUsoCards || 0}</span>
                        <span class="user-stat-label">En Uso</span>
                    </div>
                    <div class="user-stat">
                        <span class="user-stat-number">${profile.vencidoCards || 0}</span>
                        <span class="user-stat-label">Vencidos</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin: 1rem 0;">
                    <div class="user-stat">
                        <span class="user-stat-number">BsF ${(profile.totalSpent || 0).toLocaleString()}</span>
                        <span class="user-stat-label">Total Gastado</span>
                    </div>
                    <div class="user-stat">
                        <span class="user-stat-number">${profile.bingosWon || 0}</span>
                        <span class="user-stat-label">Bingos Ganados</span>
                    </div>
                    <div class="user-stat">
                        <span class="user-stat-number">BsF ${(profile.totalPrizes || 0).toLocaleString()}</span>
                        <span class="user-stat-label">Premios Ganados</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <h5 style="margin: 0 0 0.5rem 0; color: var(--accent-color);">üí∞ √öltimas Compras:</h5>
                        <div class="user-history">
                            ${(profile.purchases || []).slice(0, 5).map(purchase => `
                                <div class="history-item">
                                    <div class="history-date">${purchase.date}</div>
                                    <div>${purchase.cartones} cartones - BsF ${purchase.amount}</div>
                                    <div style="color: ${getStatusColor(purchase.status)}">${purchase.status.toUpperCase()}</div>
                                </div>
                            `).join('') || '<p style="color: #666; font-size: 0.8rem;">Sin compras</p>'}
                        </div>
                    </div>
                    <div>
                        <h5 style="margin: 0 0 0.5rem 0; color: var(--accent-color);">üèÜ √öltimos Premios:</h5>
                        <div class="user-history">
                            ${(profile.winners || []).slice(0, 5).map(winner => `
                                <div class="history-item">
                                    <div class="history-date">${winner.date}</div>
                                    <div>${winner.type} - BsF ${winner.amount}</div>
                                </div>
                            `).join('') || '<p style="color: #666; font-size: 0.8rem;">Sin premios</p>'}
                        </div>
                    </div>
                </div>
                
                <div class="user-activity">
                    <h5 style="margin: 0 0 0.5rem 0; color: var(--accent-color);">üìä Actividad Reciente:</h5>
                    ${generateUserActivity(profile)}
                </div>
            `;
        }
        
        function getUserLevel(profile) {
            const totalSpent = profile.totalSpent || 0;
            const totalPurchases = profile.totalPurchases || 0;
            
            if (totalSpent >= 5000) return 'PREMIUM';
            if (totalSpent >= 2000) return 'VIP';
            if (totalPurchases >= 5) return 'ACTIVO';
            return 'NORMAL';
        }
        
        function getStatusColor(status) {
            switch(status) {
                case 'verified': return '#28a745';
                case 'rejected': return '#dc3545';
                case 'pending': return '#ffc107';
                default: return '#666';
            }
        }
        
        function generateUserActivity(profile) {
            const activities = [];
            
            // Agregar compras recientes
            (profile.purchases || []).slice(0, 3).forEach(purchase => {
                activities.push({
                    date: purchase.date || 'N/A',
                    action: `Compr√≥ ${purchase.cartones || 0} cartones por BsF ${purchase.amount || 0}`,
                    type: 'purchase'
                });
            });
            
            // Agregar premios recientes
            (profile.winners || []).slice(0, 2).forEach(winner => {
                activities.push({
                    date: winner.date || 'N/A',
                    action: `Gan√≥ ${winner.type || 'Premio'} - BsF ${winner.amount || 0}`,
                    type: 'win'
                });
            });
            
            // Ordenar por fecha
            activities.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            return activities.slice(0, 5).map(activity => `
                <div class="activity-item">
                    <span class="activity-date">${activity.date}</span> - ${activity.action}
                </div>
            `).join('') || '<p style="color: #666; font-size: 0.8rem;">Sin actividad reciente</p>';
        }
        
        // Permitir buscar con Enter
        document.getElementById('user-phone-search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchUser();
            }
        });
        
        // Permitir filtrar ganadores con Enter
        document.getElementById('winner-phone-filter').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                filterWinners();
            }
        });
        
        document.getElementById('winner-date-filter').addEventListener('change', filterWinners);
        
        // Funci√≥n para dropdown de usuarios
        function selectUserFromDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            const selectedPhone = dropdown.value;
            if (selectedPhone) {
                document.getElementById('user-phone-search').value = selectedPhone;
                searchUser();
            }
        }
        
        // Funciones de gesti√≥n de usuarios
        async function editUser(phone) {
            const newName = prompt('Nuevo nombre para el usuario:', 'Usuario ' + phone.slice(-4));
            if (!newName) return;
            
            const { database, ref, get, set } = window.firebase;
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            
            try {
                const snapshot = await get(ref(database, `users/${cleanPhone}`));
                const userData = snapshot.val();
                userData.name = newName;
                await set(ref(database, `users/${cleanPhone}`), userData);
                showPopup('Usuario Actualizado', `Nombre cambiado a: ${newName}`);
                searchUser();
            } catch (error) {
                showPopup('Error', 'Error actualizando usuario: ' + error.message);
            }
        }
        
        async function resetUserPIN(phone) {
            if (!confirm('¬øResetear PIN del usuario? Se generar√° un PIN temporal: 0000')) return;
            
            const { database, ref, get, set } = window.firebase;
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            
            try {
                const snapshot = await get(ref(database, `users/${cleanPhone}`));
                const userData = snapshot.val();
                userData.pin = hashPIN('0000');
                userData.pinReset = true;
                userData.resetDate = new Date().toISOString();
                await set(ref(database, `users/${cleanPhone}`), userData);
                showPopup('PIN Reseteado', 'PIN temporal: 0000\nEl usuario debe cambiarlo en su pr√≥ximo acceso');
            } catch (error) {
                showPopup('Error', 'Error reseteando PIN: ' + error.message);
            }
        }
        
        async function blockUser(phone) {
            if (!confirm('¬øBloquear usuario? No podr√° realizar compras')) return;
            
            const { database, ref, get, set } = window.firebase;
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            
            try {
                const snapshot = await get(ref(database, `users/${cleanPhone}`));
                const userData = snapshot.val();
                userData.blocked = true;
                userData.blockDate = new Date().toISOString();
                await set(ref(database, `users/${cleanPhone}`), userData);
                showPopup('Usuario Bloqueado', 'El usuario no podr√° realizar compras');
                searchUser();
            } catch (error) {
                showPopup('Error', 'Error bloqueando usuario: ' + error.message);
            }
        }
        
        async function unblockUser(phone) {
            const { database, ref, get, set } = window.firebase;
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            
            try {
                const snapshot = await get(ref(database, `users/${cleanPhone}`));
                const userData = snapshot.val();
                userData.blocked = false;
                delete userData.blockDate;
                await set(ref(database, `users/${cleanPhone}`), userData);
                showPopup('Usuario Desbloqueado', 'El usuario puede realizar compras nuevamente');
                searchUser();
            } catch (error) {
                showPopup('Error', 'Error desbloqueando usuario: ' + error.message);
            }
        }
        
        async function giftCards(phone) {
            const quantity = prompt('¬øCu√°ntos cartones regalar?', '1');
            if (!quantity || isNaN(quantity) || quantity < 1) return;
            
            try {
                generateCardsForPlayer(phone, parseInt(quantity));
                showPopup('Cartones Regalados', `Se regalaron ${quantity} cartones a ${phone}`);
            } catch (error) {
                showPopup('Error', 'Error regalando cartones: ' + error.message);
            }
        }
        
        async function deleteUser(phone) {
            if (!confirm('‚ö†Ô∏è ELIMINAR USUARIO\n\n¬øEst√°s seguro? Esta acci√≥n eliminar√°:\n‚Ä¢ Cuenta del usuario\n‚Ä¢ Todos sus cartones\n‚Ä¢ Historial de compras\n\nEsta acci√≥n NO se puede deshacer.')) return;
            
            const { database, ref, set } = window.firebase;
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            
            try {
                // Eliminar usuario
                await set(ref(database, `users/${cleanPhone}`), null);
                // Eliminar cartones
                await set(ref(database, `playerCards/${cleanPhone}`), null);
                showPopup('Usuario Eliminado', 'Usuario y todos sus datos han sido eliminados');
                document.getElementById('user-profile').style.display = 'none';
                loadAllUsers();
            } catch (error) {
                showPopup('Error', 'Error eliminando usuario: ' + error.message);
            }
        }
        
        function exportUserData(phone) {
            getUserProfile(phone).then(profile => {
                if (!profile) return;
                
                const data = {
                    usuario: profile,
                    exportDate: new Date().toISOString(),
                    exportedBy: 'Admin Panel'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `usuario_${phone}_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showPopup('Datos Exportados', 'Archivo descargado exitosamente');
            });
        }
        
        function hashPIN(pin) {
            let hash = 0;
            for (let i = 0; i < pin.length; i++) {
                const char = pin.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }
        
        // Funci√≥n para expirar todos los cartones activos en Firebase
        function expireAllCardsInFirebase() {
            if (!window.firebase) {
                console.error('‚ùå Firebase no disponible - no se pueden expirar cartones');
                return;
            }
            
            const { database, ref, get, set } = window.firebase;
            
            // Obtener todos los cartones de todos los jugadores
            get(ref(database, 'playerCards')).then((snapshot) => {
                const allPlayerCards = snapshot.val();
                if (!allPlayerCards) return;
                
                let hasChanges = false;
                
                // Iterar por cada jugador
                Object.keys(allPlayerCards).forEach(phone => {
                    const playerCards = allPlayerCards[phone];
                    if (Array.isArray(playerCards)) {
                        playerCards.forEach(card => {
                            if (card.status === 'en_uso' || card.status === 'vigente') {
                                card.status = 'vencido';
                                card.expiredDate = new Date().toISOString();
                                card.expiredReason = 'Juego completado';
                                hasChanges = true;
                            }
                        });
                    }
                });
                
                if (hasChanges) {
                    // Guardar todos los cartones actualizados
                    return set(ref(database, 'playerCards'), allPlayerCards);
                }
            })
            .then(() => {
                console.log('‚úÖ Todos los cartones marcados como vencidos en Firebase');
            })
            .catch(error => {
                console.error('‚ùå Error expirando cartones:', error);
            });
        }
        
        // Funci√≥n para resetear premios despu√©s de partida completa
        function resetPrizesAfterCompleteGame() {
            // Limpiar compras verificadas para resetear premios
            localStorage.setItem('verifiedPurchases', JSON.stringify([]));
            
            // Resetear variables del admin
            ticketsSoldToday = 0;
            dailyPrizeTotal = 0;
            
            // Actualizar stats
            updateStats();
            
            console.log('Premios reseteados despu√©s de partida completa');
        }
        
        // FUNCIONES PARA CONFIGURACI√ìN DE DOMINIO
        function loadDomainConfig() {
            const savedDomain = localStorage.getItem('bingoDomain');
            if (savedDomain) {
                document.getElementById('domain-input').value = savedDomain;
                document.getElementById('domain-status').textContent = `Dominio configurado: ${savedDomain}`;
                document.getElementById('domain-status').classList.add('configured');
            }
        }
        
        function saveDomainConfig() {
            const domain = document.getElementById('domain-input').value.trim();
            
            if (!domain) {
                showPopup('Error', 'Ingresa un dominio v√°lido');
                return;
            }
            
            // Validar formato b√°sico de dominio
            const domainRegex = /^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?\.[a-zA-Z]{2,}$/;
            if (!domainRegex.test(domain)) {
                showPopup('Error', 'Formato de dominio inv√°lido. Ej: mi-bingo.com');
                return;
            }
            
            localStorage.setItem('bingoDomain', domain);
            
            if (window.firebase) {
                const { database, ref, set } = window.firebase;
                set(ref(database, 'config/domain'), domain)
                    .then(() => console.log('‚úÖ Dominio guardado en Firebase'))
                    .catch(error => console.error('‚ùå Error guardando dominio:', error));
            }
            
            document.getElementById('domain-status').textContent = `Dominio configurado: ${domain}`;
            document.getElementById('domain-status').classList.add('configured');
            
            showPopup('Dominio Guardado', `Dominio configurado: ${domain}`);
        }
        
        // SISTEMA DE LIMPIEZA SELECTIVA
        document.getElementById('open-clean-modal').addEventListener('click', () => {
            document.getElementById('clean-modal').style.display = 'flex';
        });
        
        function closeCleanModal() {
            document.getElementById('clean-modal').style.display = 'none';
            clearAllClean();
        }
        
        function selectAllClean() {
            const checkboxes = document.querySelectorAll('#clean-modal input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
        }
        
        function clearAllClean() {
            const checkboxes = document.querySelectorAll('#clean-modal input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
        }
        
        // Manejar checkbox "Eliminar Todo"
        document.getElementById('clean-all').addEventListener('change', function() {
            if (this.checked) {
                selectAllClean();
            }
        });
        
        function executeClean() {
            const selected = getSelectedCleanOptions();
            
            if (selected.length === 0) {
                showPopup('Sin Selecci√≥n', 'Selecciona al menos una opci√≥n para limpiar');
                return;
            }
            
            const confirmText = `üßπ CONFIRMAR LIMPIEZA\n\nSe limpiar√°n las siguientes categor√≠as:\n${selected.map(s => '‚Ä¢ ' + s.name).join('\n')}\n\n¬øContinuar?`;
            
            if (confirm(confirmText)) {
                performSelectiveClean(selected);
                closeCleanModal();
            }
        }
        
        function getSelectedCleanOptions() {
            const options = [
                { id: 'clean-gamestate', name: 'Estado del juego', firebase: ['gameState', 'calledNumbers'], localStorage: ['bingoGameState', 'pendingBingoVerification', 'globalBingoAlert', 'bingoVerificationResult'] },
                { id: 'clean-winners', name: 'Ganadores y premios', firebase: ['winners', 'prizes'], localStorage: ['bingoWinners', 'bingoPrizes'] },
                { id: 'clean-schedules', name: 'Horarios completados', firebase: [], localStorage: [], action: 'resetSchedules' },
                { id: 'clean-patterns', name: 'Patrones de juego', firebase: [], localStorage: [], action: 'resetPatterns' },
                { id: 'clean-pending', name: 'Compras pendientes', firebase: [], localStorage: ['pendingPurchases'], action: 'filterPurchases', filter: 'pending' },
                { id: 'clean-verified', name: 'Compras verificadas', firebase: [], localStorage: ['verifiedPurchases'], action: 'filterPurchases', filter: 'verified' },
                { id: 'clean-rejected', name: 'Compras rechazadas', firebase: [], localStorage: ['rejectedPurchases'], action: 'filterPurchases', filter: 'rejected' },
                { id: 'clean-stats', name: 'Estad√≠sticas de ventas', firebase: [], localStorage: [], action: 'resetStats' },
                { id: 'clean-cards', name: 'Cartones de jugadores', firebase: ['playerCards'], localStorage: ['playerCards'] },
                { id: 'clean-profiles', name: 'Perfiles de usuarios', firebase: [], localStorage: ['userPhone', 'userProfile'] },
                { id: 'clean-sessions', name: 'Sesiones activas', firebase: [], localStorage: [], action: 'clearSessions' },
                { id: 'clean-cache', name: 'Cach√© del navegador', firebase: [], localStorage: [], action: 'clearCache' },
                { id: 'clean-alerts', name: 'Alertas y notificaciones', firebase: [], localStorage: [], action: 'clearAlerts' },
                { id: 'clean-logs', name: 'Logs del sistema', firebase: [], localStorage: [], action: 'clearLogs' }
            ];
            
            return options.filter(option => document.getElementById(option.id).checked);
        }
        
        function performSelectiveClean(selectedOptions) {
            console.log('üßπ Iniciando limpieza selectiva:', selectedOptions.map(s => s.name));
            
            let firebasePromises = [];
            let localStorageKeys = [];
            let specialActions = [];
            
            selectedOptions.forEach(option => {
                // Firebase
                if (option.firebase && option.firebase.length > 0) {
                    option.firebase.forEach(fbKey => {
                        if (window.firebase) {
                            const { database, ref, set } = window.firebase;
                            firebasePromises.push(set(ref(database, fbKey), null));
                        }
                    });
                }
                
                // localStorage
                if (option.localStorage && option.localStorage.length > 0) {
                    localStorageKeys.push(...option.localStorage);
                }
                
                // Acciones especiales
                if (option.action) {
                    specialActions.push(option);
                }
            });
            
            // Ejecutar limpieza de Firebase
            if (firebasePromises.length > 0) {
                Promise.all(firebasePromises)
                    .then(() => console.log('‚úÖ Firebase limpiado'))
                    .catch(error => console.error('‚ùå Error en Firebase:', error));
            }
            
            // Ejecutar limpieza de localStorage
            localStorageKeys.forEach(key => {
                localStorage.removeItem(key);
            });
            
            // Ejecutar acciones especiales
            specialActions.forEach(action => {
                executeSpecialAction(action);
            });
            
            // Actualizar displays
            setTimeout(() => {
                loadPendingPurchases();
                loadWinners();
                updatePrizeStats();
                showPrizeTab('pending');
                initializeNewSystem();
                updateStats();
            }, 1000);
            
            showPopup('üßπ LIMPIEZA COMPLETADA', `Se limpiaron ${selectedOptions.length} categor√≠as exitosamente`);
        }
        
        function executeSpecialAction(action) {
            switch(action.action) {
                case 'resetSchedules':
                    dailySchedule.forEach(bingo => bingo.completed = false);
                    break;
                case 'resetPatterns':
                    currentPattern = null;
                    break;
                case 'resetStats':
                    dailyPrizeTotal = 0;
                    ticketsSoldToday = 0;
                    break;
                case 'filterPurchases':
                    if (window.firebase) {
                        // Filtrar compras por estado en Firebase
                        const { database, ref, onValue, set } = window.firebase;
                        onValue(ref(database, 'purchases'), (snapshot) => {
                            const purchases = snapshot.val();
                            if (purchases) {
                                const filtered = Object.values(purchases).filter(p => p.status !== action.filter);
                                const newPurchases = {};
                                filtered.forEach(p => newPurchases[p.id] = p);
                                set(ref(database, 'purchases'), newPurchases);
                            }
                        }, { onlyOnce: true });
                    }
                    break;
                case 'clearSessions':
                    gameActive = false;
                    selectedBingoIndex = -1;
                    currentRound = 1;
                    stopAutomaticCalling();
                    break;
                case 'clearCache':
                    if ('caches' in window) {
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                        });
                    }
                    break;
                case 'clearAlerts':
                    document.querySelectorAll('.bingo-alert, .pause-alert, .winner-alert').forEach(alert => {
                        alert.style.display = 'none';
                    });
                    break;
                case 'clearLogs':
                    console.clear();
                    break;
            }
        }
        
        // Generar cartones para jugador
        function generateCardsForPlayer(phone, quantity) {
            const cards = [];
            
            for (let i = 0; i < quantity; i++) {
                const card = {
                    id: Date.now() + i,
                    code: generateCardCode(),
                    numbers: generateBingoCard(),
                    marked: [],
                    status: 'vigente',
                    autoMode: true,
                    purchaseDate: new Date().toISOString(),
                    phone: phone
                };
                cards.push(card);
            }
            
            if (window.firebase) {
                saveCardsToFirebase(phone, cards);
            }
            
            // Mantener localStorage como backup
            const allCards = JSON.parse(localStorage.getItem('playerCards') || '[]');
            allCards.push(...cards);
            localStorage.setItem('playerCards', JSON.stringify(allCards));
            
            console.log(`Generados ${quantity} cartones para ${phone}`);
        }
        
        function generateCardCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 5; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        function generateBingoCard() {
            const card = [];
            const ranges = [[1,15], [16,30], [31,45], [46,60], [61,75]];
            
            for (let col = 0; col < 5; col++) {
                const column = [];
                const [min, max] = ranges[col];
                const numbers = [];
                
                while (numbers.length < 5) {
                    const num = Math.floor(Math.random() * (max - min + 1)) + min;
                    if (!numbers.includes(num)) {
                        numbers.push(num);
                    }
                }
                
                numbers.sort((a, b) => a - b);
                
                for (let row = 0; row < 5; row++) {
                    if (!card[row]) card[row] = [];
                    card[row][col] = row === 2 && col === 2 ? 0 : numbers[row]; // Centro FREE
                }
            }
            
            return card;
        }
        
        // FUNCIONES FIREBASE PARA GANADORES Y PREMIOS
        function saveWinnerToFirebase(winner) {
            if (!window.firebase) return;
            
            const { database, ref, set } = window.firebase;
            set(ref(database, `winners/${winner.id}`), winner)
                .then(() => console.log('‚úÖ Ganador guardado en Firebase'))
                .catch(error => console.error('‚ùå Error guardando ganador:', error));
        }
        
        function savePrizeToFirebase(prize) {
            if (!window.firebase) return;
            
            const { database, ref, set } = window.firebase;
            set(ref(database, `prizes/${prize.id}`), prize)
                .then(() => console.log('‚úÖ Premio guardado en Firebase'))
                .catch(error => console.error('‚ùå Error guardando premio:', error));
        }
        
        function loadWinnersFromFirebase() {
            if (!window.firebase) return;
            
            const { database, ref, onValue } = window.firebase;
            onValue(ref(database, 'winners'), (snapshot) => {
                const firebaseWinners = snapshot.val();
                if (firebaseWinners) {
                    bingoWinners = Object.values(firebaseWinners).sort((a, b) => b.id - a.id);
                    loadWinners();
                }
            });
            
            onValue(ref(database, 'prizes'), (snapshot) => {
                const firebasePrizes = snapshot.val();
                if (firebasePrizes) {
                    bingoPrizes = Object.values(firebasePrizes).sort((a, b) => b.id - a.id);
                    updatePrizeStats();
                    showPrizeTab(currentPrizeTab);
                }
            });
        }
        
        // FUNCIONES FIREBASE PARA CARTONES
        function saveCardsToFirebase(phone, cards) {
            if (!window.firebase) return;
            
            const { database, ref, set } = window.firebase;
            set(ref(database, `playerCards/${phone.replace(/[^0-9]/g, '')}`), cards)
                .then(() => console.log('‚úÖ Cartones guardados en Firebase'))
                .catch(error => console.error('‚ùå Error guardando cartones:', error));
        }
        
        function loadCardsFromFirebase(phone) {
            if (!window.firebase) return Promise.resolve(null);
            
            const { database, ref, get } = window.firebase;
            return get(ref(database, `playerCards/${phone.replace(/[^0-9]/g, '')}`));
        }
        
        // FUNCIONES FIREBASE PARA COMPRAS Y PAGOS
        function savePurchaseToFirebase(purchase) {
            if (!window.firebase) return;
            
            const { database, ref, set } = window.firebase;
            set(ref(database, `purchases/${purchase.id}`), purchase)
                .then(() => console.log('‚úÖ Compra guardada en Firebase'))
                .catch(error => console.error('‚ùå Error guardando compra:', error));
        }
        
        function loadPurchasesFromFirebase() {
            if (!window.firebase) {
                loadPendingPurchases(); // Fallback a localStorage
                return;
            }
            
            const { database, ref, onValue } = window.firebase;
            onValue(ref(database, 'purchases'), (snapshot) => {
                const firebasePurchases = snapshot.val();
                if (firebasePurchases) {
                    allPayments = Object.values(firebasePurchases);
                    updatePaymentStats();
                    if (document.getElementById('payment-modal').style.display === 'flex') {
                        filterPayments();
                    }
                    console.log('‚úÖ Compras cargadas desde Firebase:', allPayments.length);
                }
            });
        }
        
        function updatePurchaseInFirebase(purchase) {
            if (!window.firebase) return;
            
            const { database, ref, set } = window.firebase;
            set(ref(database, `purchases/${purchase.id}`), purchase)
                .then(() => console.log('‚úÖ Compra actualizada en Firebase'))
                .catch(error => console.error('‚ùå Error actualizando compra:', error));
        }
        
        // FUNCIONES FIREBASE PARA ESTADO DEL JUEGO
        function saveGameStateToFirebase() {
            if (!window.firebase) return;
            
            const { database, ref, set } = window.firebase;
            const verifiedPurchases = JSON.parse(localStorage.getItem('verifiedPurchases') || '[]');
            const totalRecaudado = verifiedPurchases.reduce((sum, p) => sum + p.cartones, 0) * 60;
            const totalParaPremios = totalRecaudado * 0.75;
            
            const gameState = {
                gameActive: gameActive, // Solo true cuando el admin presiona "Iniciar Ronda"
                currentRound: currentRound,
                selectedBingoIndex: selectedBingoIndex,
                roundPrize: currentRound === 1 ? totalParaPremios * 0.25 : totalParaPremios * 0.75,
                calledNumbers: calledNumbers,
                currentPattern: currentPattern,
                timestamp: Date.now(),
                isPaused: false,
                adminStarted: true // Marca que fue iniciado por el admin
            };
            
            set(ref(database, 'gameState'), gameState)
                .then(() => console.log('‚úÖ Estado guardado en Firebase'))
                .catch(error => console.error('‚ùå Error guardando estado:', error));
        }
        
        function pauseGameInFirebase(reason = 'admin_pause') {
            if (!window.firebase) return;
            
            const { database, ref, set } = window.firebase;
            const gameState = {
                gameActive: false,
                currentRound: currentRound,
                selectedBingoIndex: selectedBingoIndex,
                calledNumbers: calledNumbers,
                currentPattern: currentPattern,
                isPaused: true,
                pauseReason: reason,
                pauseTimestamp: Date.now(),
                timestamp: Date.now()
            };
            
            set(ref(database, 'gameState'), gameState)
                .then(() => console.log('‚úÖ Juego pausado en Firebase'))
                .catch(error => console.error('‚ùå Error pausando:', error));
        }
        
        function saveCalledNumberToFirebase(numberData) {
            if (!window.firebase) return;
            
            const { database, ref, set } = window.firebase;
            set(ref(database, 'calledNumbers'), calledNumbers)
                .then(() => console.log('‚úÖ N√∫mero guardado:', numberData.number))
                .catch(error => console.error('‚ùå Error guardando n√∫mero:', error));
        }
    </script>
</body>
</html>